{% extends 'base/base.html' %}
<!-- block -->
{% block content %}
<!-- clockdb -->
<div class="clockdb">
    <!-- Working Paper -->
    <section class="Ï†">
        {% include 'analysis/valuation/graph.html' %}
        {% include 'analysis/valuation/opinion.html' %}
        {% include 'analysis/valuation/intrinsicvalues.html' %}
        {% include 'analysis/valuation/capitalizedcashflow.html' %}
        {% include 'analysis/valuation/capitalizedincome.html' %}
        {% include 'analysis/valuation/capitalizationrates.html' %}
        {% include 'analysis/valuation/financialratios.html' %}
        {% include 'analysis/valuation/additionalinformation.html' %}
        {% include 'analysis/financials/balancesheets.html' %}
        {% include 'analysis/financials/comprehensiveincome.html' %}
        {% include 'analysis/financials/incomestatements.html' %}
        {% include 'analysis/financials/shareholdersequity.html' %}
        {% include 'analysis/financials/cashflow.html' %}
        {% include 'analysis/financials/trialbalances.html' %}
        {% include 'analysis/audit/summary.html' %}
        {% include 'analysis/audit/anomalies.html' %}
        {% include 'analysis/audit/procedures/balancesheets.html' %}
        {% include 'analysis/audit/procedures/incomestatements.html' %}
        {% include 'analysis/audit/procedures/comprehensiveincome.html' %}
        {% include 'analysis/audit/procedures/shareholdersequity.html' %}
        {% include 'analysis/audit/procedures/cashflow.html' %}
        {% include 'analysis/audit/materiality.html' %}
        {% include 'analysis/audit/mission.html' %}
        {% include 'analysis/context.html' %}
        {% include 'analysis/files.html' %}
        {% include 'analysis/referencemap.html' %}
    </section>
    <!-- Content -->
    {% include 'search/Entities.html' %}
    {% include 'search/Posts.html' %}
    {% include 'search/Network.html' %}
    {% include 'more/about.html' %}
    {% include 'more/commands.html' %}
    {% include 'more/disclaimer.html' %}
    {% include 'more/documentation.html' %}
    {% include 'profile/profile.html' %}
    {% include 'profile/edit.html' %}
    {% include 'profile/friend_requests.html' %}
    {% include 'profile/notifications/general_notifications.html' %}
    {% include 'profile/notifications/chat_notifications.html' %}
</div>

<!-- js/onePageApp.js -->
<script>

    console.log('onePageApp.js')
    
    const GENERAL_NOTIFICATION_INTERVAL = 4000
    const GENERAL_NOTIFICATION_TIMEOUT = 5000

    var generalCachedNotifList = new List([])

    function submitGeneralNotificationToCache(notification){
        var result = generalCachedNotifList.filter(function(n){ 
            return n['notification_id'] === notification['notification_id']
        })
        if(result.length == 0){
            generalCachedNotifList.push(notification)

            appendBottomGeneralNotification(notification)
        }
        else{
            refreshGeneralNotificationsList(notification)
        }
    }

    function refreshGeneralNotificationsList(notification){
        notificationContainer = document.getElementById("id_general_notifications_container")

        if(notificationContainer != null){
            divs = notificationContainer.childNodes

            divs.forEach(function(card){
                if(card.id == ("id_notification_" + notification['notification_id'])){
                    
                    switch(notification['notification_type']) {

                        case "FriendRequest":
                            refreshFriendRequestCard(card, notification)
                            break;

                        case "FriendList":
                            refreshFriendListCard(card, notification)
                            break;

                        default:
                    }
                }
            })
        }
    }

    function handleGeneralNotificationsData(notifications, new_page_number){
        if(notifications.length > 0){
            clearNoGeneralNotificationsCard()
            notifications.forEach(notification => {

                submitGeneralNotificationToCache(notification)

                setGeneralOldestTimestamp(notification['timestamp'])
                setGeneralNewestTimestamp(notification['timestamp'])
            })
            setGeneralPageNumber(new_page_number)
        }
    }

    function handleNewGeneralNotificationsData(notifications){
        if(notifications.length > 0){
            clearNoGeneralNotificationsCard()
            notifications.forEach(notification => {

                submitNewGeneralNotificationToCache(notification)

                setGeneralOldestTimestamp(notification['timestamp'])
                setGeneralNewestTimestamp(notification['timestamp'])
            })
        }
    }

    function submitNewGeneralNotificationToCache(notification){
        var result = generalCachedNotifList.filter(function(n){ 
            return n['notification_id'] === notification['notification_id']
        })
        if(result.length == 0){
            generalCachedNotifList.push(notification)

            appendTopGeneralNotification(notification)
        }
        else{
            refreshGeneralNotificationsList(notification)
        }
    }

    function refreshGeneralNotificationsData(notifications){
        if(notifications.length > 0){
            clearNoGeneralNotificationsCard()
            notifications.forEach(notification => {

                submitGeneralNotificationToCache(notification)

                setGeneralOldestTimestamp(notification['timestamp'])
                setGeneralNewestTimestamp(notification['timestamp'])
            })
        }
    }

    function appendTopGeneralNotification(notification){

        switch(notification['notification_type']) {

            case "FriendRequest":
                notificationContainer = document.getElementById("id_general_notifications_container")
                card = createFriendRequestElement(notification)
                notificationContainer.insertBefore(card, notificationContainer.childNodes[0]);
                break;

            case "FriendList":
                notificationContainer = document.getElementById("id_general_notifications_container")
                card = createFriendListElement(notification)
                notificationContainer.insertBefore(card, notificationContainer.childNodes[0]);
                break;

            default:
                // code block
        }

        preloadImage(notification['from']['image_url'], assignGeneralImgId(notification))
    }

    function appendBottomGeneralNotification(notification){

        switch(notification['notification_type']) {

            case "FriendRequest":
                notificationContainer = document.getElementById("id_general_notifications_container")
                card = createFriendRequestElement(notification)
                notificationContainer.appendChild(card)
                break;

            case "FriendList":
                notificationContainer = document.getElementById("id_general_notifications_container")
                card = createFriendListElement(notification)
                notificationContainer.appendChild(card)
                break;

            default:
                // code block
        }
        preloadImage(notification['from']['image_url'], assignGeneralImgId(notification))
    }

    function refreshFriendRequestCard(card, notification){
        card.childNodes.forEach(function(element){

            // DIV1
            if(element.id == ("id_general_div1_" + notification['notification_id'])){
                element.childNodes.forEach(function(child){
                    if(child.id == ("id_general_verb_" + notification['notification_id'])){
                        // found verb
                        child.innerHTML = notification['verb']
                    }
                })
            }
                
            // DIV2
            if (element.id == ("id_general_div2_" + notification['notification_id'])){
                if(notification['is_active'] == "True"){
                        // do nothing
                }
                else{
                    // remove buttons b/c it has been answered
                    card.removeChild(element)
                }
            }

            // TIMESTAMP
            if (element.id == ("id_timestamp_" + notification['notification_id'])){
                element.innerHTML = notification['natural_timestamp']
            }
        })
    }

    function refreshFriendListCard(card, notification){
        card.childNodes.forEach(function(element){

            // DIV1
            if(element.id == ("id_general_div1_" + notification['notification_id'])){
                element.childNodes.forEach(function(child){
                    if(child.id == ("id_general_verb_" + notification['notification_id'])){
                        // found verb
                        child.innerHTML = notification['verb']
                    }
                })
            }

            // TIMESTAMP
            if (element.id == ("id_timestamp_" + notification['notification_id'])){
                element.innerHTML = notification['natural_timestamp']
            }
        })
    }

    function createFriendListElement(notification){
        card = createGeneralNotificationCard()
        card.id = assignGeneralCardId(notification)
        card.addEventListener("click", function(){
            a = notification['actions'].redirect_url
            a = a.replace(window.location.origin,'')
            a = a.replace(/\//g, '')
            a = a.replace(/account/g, '')
            a = a.replace(/profile/g, '')
            url = '/' + a + '/profile/'
            window.open(url, '_self');
        })

        var div1 = document.createElement("div")
        div1.classList.add("d-flex", "flex-row", "align-items-start")
        div1.id = assignGeneralDiv1Id(notification)

        img = createGeneralProfileImageThumbnail(notification)
        div1.appendChild(img)

        span = document.createElement("span")
        span.classList.add("align-items-start", "pt-1", "m-auto")
        if(notification['verb'].length > 50){
            span.innerHTML = notification['verb'].slice(0, 50) + "..."
        }
        else{
            span.innerHTML = notification['verb']
        }
        span.id = assignGeneralVerbId(notification)
        div1.appendChild(span)
        card.appendChild(div1)
        card.appendChild(createGeneralTimestampElement(notification))

        return card
    }

    function createFriendRequestElement(notification){
        card = createGeneralNotificationCard()

        // assign id b/c we need to find this div if they accept/decline the friend request
        card.id = assignGeneralCardId(notification)
        //
        card.addEventListener("click", function(){
            a = notification['actions'].redirect_url
            a = a.replace(window.location.origin,'')
            a = a.replace(/\//g, '')
            a = a.replace(/account/g, '')
            a = a.replace(/profile/g, '')
            url = '/' + a + '/profile/'
            window.open(url, '_self');
        })

        // Is the friend request PENDING? (not answered yet)
        if(notification['is_active'] == "True"){

            //console.log("found an active friend request")
            div1 = document.createElement("div")
            div1.classList.add("d-flex", "flex-row", "align-items-start")
            div1.id = assignGeneralDiv1Id(notification)
            
            img = createGeneralProfileImageThumbnail(notification)
            div1.appendChild(img)

            span = document.createElement("span")
            span.classList.add("m-auto")
            span.innerHTML = notification['verb']
            span.id = assignGeneralVerbId(notification)
            div1.appendChild(span)
            card.appendChild(div1)

            div2 = document.createElement("div")
            div2.classList.add("d-flex", "flex-row", "mt-2")
            div2.id = assignGeneralDiv2Id(notification)

            pos_action = document.createElement("a")
            pos_action.classList.add("btn", "btn-primary", "mr-2")
            pos_action.href = "#"
            pos_action.innerHTML = "Accept"
            pos_action.addEventListener("click", function(e){
                e.stopPropagation();
                sendAcceptFriendRequestToSocket(notification['notification_id'])
            })
            pos_action.id = assignGeneralPosActionId(notification)
            div2.appendChild(pos_action)

            neg_action = document.createElement("a")
            neg_action.classList.add("btn", "btn-secondary")
            neg_action.href = "#"
            neg_action.innerHTML = "Decline"
            neg_action.addEventListener("click", function(e){
                e.stopPropagation();
                sendDeclineFriendRequestToSocket(notification['notification_id'])
            })
            neg_action.id = assignGeneralNegActionId(notification)
            div2.appendChild(neg_action)
            card.appendChild(div2)
        }
        // The friend request has been answered (Declined or accepted)
        else{
            var div1 = document.createElement("div")
            div1.classList.add("d-flex", "flex-row", "align-items-start")
            div1.id = assignGeneralDiv1Id(notification)

            img = createGeneralProfileImageThumbnail(notification)
            img.id = assignGeneralImgId(notification)
            div1.appendChild(img)

            span = document.createElement("span")
            span.classList.add("m-auto")
            span.innerHTML = notification['verb']
            span.id = assignGeneralVerbId(notification)
            div1.appendChild(span)
            card.appendChild(div1)
        }
        card.appendChild(createGeneralTimestampElement(notification))

        return card
    }

    function setupGeneralNotificationsMenu(){
        var notificationContainer = document.getElementById("id_general_notifications_container")

        if(notificationContainer != null){
            card = createGeneralNotificationCard("id_no_general_notifications")

            var div = document.createElement("div")
            div.classList.add("d-flex", "flex-row", "align-items-start")

            span = document.createElement("span")
            span.classList.add("align-items-start", "pt-1", "m-auto")
            span.innerHTML = "You have no notifications."
            div.appendChild(span)
            card.appendChild(div)
            notificationContainer.appendChild(card)
        }
    }

    function clearNoGeneralNotificationsCard(){
        var element = document.getElementById("id_no_general_notifications")
        if(element != null && element != "undefined"){
            document.getElementById("id_general_notifications_container").removeChild(element)
        }
    }

    function createGeneralNotificationCard(cardId){
        var card = document.createElement("div")
        if(cardId != "undefined"){
            card.id = cardId
        }
        card.classList.add("d-flex", "flex-column", "align-items-start", "general-card", "p-4")
        return card
    }

    function createGeneralProfileImageThumbnail(notification){
        var img = document.createElement("img")
        img.classList.add("notification-thumbnail-image", "img-fluid", "rounded-circle", "mr-2")
        img.src = "{% static 'clockdb/dummy_image.png' %}".replace(/&amp;/g, "&")
        img.id = assignGeneralImgId(notification)
        return img
    }

    function createGeneralTimestampElement(notification){
        var timestamp = document.createElement("p")
        timestamp.classList.add("small", "pt-2", "timestamp-text")
        timestamp.innerHTML = notification['natural_timestamp']
        timestamp.id = assignGeneralTimestampId(notification)
        return timestamp
    }

    function updateGeneralNotificationDiv(notification){
        notificationContainer = document.getElementById("id_general_notifications_container")

        if(notificationContainer != null){
            divs = notificationContainer.childNodes

            divs.forEach(function(element){
                if(element.id == ("id_notification_" + notification['notification_id'])){
                    
                    // Replace current div with updated one
                    updatedDiv = createFriendRequestElement(notification)
                    element.replaceWith(updatedDiv)
                }
            })
        }
    }

    function setOnGeneralNotificationScrollListener(){
        var menu = document.getElementById("id_general_notifications_container")
        if(menu != null ){
            menu.addEventListener("scroll", function(e){

                if ((menu.scrollTop) >= (menu.scrollHeight - menu.offsetHeight)) {
                    getNextGeneralNotificationsPage()
                }
            });
        }
    }

    setOnGeneralNotificationScrollListener()

    function setGeneralPaginationExhausted(){
        //console.log("general pagination exhausted.")
        setGeneralPageNumber("-1")
    }

    function setGeneralPageNumber(pageNumber){
        document.getElementById("id_general_page_number").innerHTML = pageNumber
    }

    function setGeneralOldestTimestamp(timestamp){
        element = document.getElementById("id_general_oldest_timestamp")
        current = element.innerHTML
        if(Date.parse(timestamp) < Date.parse(current)){
            element.innerHTML = timestamp
        }
    }

    function setGeneralNewestTimestamp(timestamp){
        element = document.getElementById("id_general_newest_timestamp")
        current = element.innerHTML
        if(Date.parse(timestamp) > Date.parse(current)){
            element.innerHTML = timestamp
        }
        else if(current == ""){
            element.innerHTML = timestamp
        }
    }

    function setUnreadGeneralNotificationsCount(count){
        var countElement = document.getElementById("id_general_notifications_count")
        if(count > 0){
            countElement.style.display = "contents"
            countElement.innerHTML = count
        }
        else{
            countElement.style.background = "transparent"
            countElement.style.display = "none"
        }
    }

    function getUnreadGeneralNotificationsCount(){
        if("{{request.user.is_authenticated}}"){
            notificationSocket.send(JSON.stringify({
                "command": "get_unread_general_notifications_count",
            }));
        }
    }

    function setGeneralNotificationsAsRead(){
        if("{{request.user.is_authenticated}}"){
            oldestTimestamp = document.getElementById("id_general_oldest_timestamp").innerHTML
            notificationSocket.send(JSON.stringify({
                "command": "mark_notifications_read",
            }));
            getUnreadGeneralNotificationsCount()
        }
    }

    function getFirstGeneralNotificationsPage(){
        if("{{request.user.is_authenticated}}"){
            notificationSocket.send(JSON.stringify({
                "command": "get_general_notifications",
                "page_number": "1",
            }));
        }
    }

    function sendAcceptFriendRequestToSocket(notification_id){
        notificationSocket.send(JSON.stringify({
            "command": "accept_friend_request",
            "notification_id": notification_id,
        }));
    }

    function sendDeclineFriendRequestToSocket(notification_id){
        notificationSocket.send(JSON.stringify({
            "command": "decline_friend_request",
            "notification_id": notification_id,
        }));
    }

    function getNextGeneralNotificationsPage(){
        var pageNumber = document.getElementById("id_general_page_number").innerHTML
        // -1 means exhausted or a query is currently in progress
        if("{{request.user.is_authenticated}}" && pageNumber != "-1"){
            notificationSocket.send(JSON.stringify({
                "command": "get_general_notifications",
                "page_number": pageNumber,
            }));
        }
    }

    function refreshGeneralNotifications(){
        oldestTimestamp = document.getElementById("id_general_oldest_timestamp").innerHTML
        newestTimestamp = document.getElementById("id_general_newest_timestamp").innerHTML
        if("{{request.user.is_authenticated}}"){
            notificationSocket.send(JSON.stringify({
                "command": "refresh_general_notifications",
                "oldest_timestamp": oldestTimestamp,
                "newest_timestamp": newestTimestamp,
            }));
        }
    }

    function startGeneralNotificationService(){
        if("{{request.user.is_authenticated}}" == "True"){
            setInterval(refreshGeneralNotifications, GENERAL_NOTIFICATION_INTERVAL)
            setInterval(getNewGeneralNotifications, GENERAL_NOTIFICATION_INTERVAL)
            setInterval(getUnreadGeneralNotificationsCount, GENERAL_NOTIFICATION_INTERVAL)
        }
    }

    startGeneralNotificationService()

    function getNewGeneralNotifications(){
        newestTimestamp = document.getElementById("id_general_newest_timestamp").innerHTML
        if("{{request.user.is_authenticated}}"){
            notificationSocket.send(JSON.stringify({
                "command": "get_new_general_notifications",
                "newest_timestamp": newestTimestamp,
            }));
        }
    }

    function generalRedirect(url){
        window.location.href = url
    }

    function assignGeneralDiv1Id(notification){
        return "id_general_div1_" + notification['notification_id']
    }

    function assignGeneralImgId(notification){
        return "id_general_img_" + notification['notification_id']
    }

    function assignGeneralVerbId(notification){
        return "id_general_verb_" + notification['notification_id']
    }

    function assignGeneralDiv2Id(notification){
        return "id_general_div2_" + notification['notification_id']
    }

    function assignGeneralPosActionId(notification){
        return "id_general_pos_action_" + notification['notification_id']
    }

    function assignGeneralNegActionId(notification){
        return "id_general_neg_action_" + notification['notification_id']
    }

    function assignGeneralTimestampId(notification){
        return "id_timestamp_" + notification['notification_id']
    }

    function assignGeneralCardId(notification){
        return "id_notification_" + notification['notification_id']
    }

    function setInitialTimestamp(){
        // ('%Y-%m-%d %H:%M:%S.%f')
        var today = new Date();
        var month = today.getMonth()+1
        if(month.toString().length == 1){
            month = "0" + month
        }
        var day = today.getDate()
        if(day.toString().length == 1){
            day = "0" + day
        }
        var hours = today.getHours()
        if(hours.toString().length == 1){
            hours = "0" + hours
        }
        var minutes = today.getMinutes()
        if(minutes.toString().length == 1){
            minutes = "0" + minutes
        }
        var seconds = today.getSeconds()
        if(seconds.toString().length == 1){
            seconds = "0" + seconds
        }
        var ms = "000000"
        var date = today.getFullYear()+'-'+month+'-'+day + " " + hours + ":" + minutes + ":" + seconds + "." + ms
        document.getElementById("id_general_oldest_timestamp").innerHTML = date
        document.getElementById("id_general_newest_timestamp").innerHTML = date
    }

    setInitialTimestamp()

    // HEADER

    // Correctly decide between ws:// and wss://
    var ws_scheme = window.location.protocol == "https:" ? "wss" : "ws";
    {% if debug_mode %}
        var ws_path = ws_scheme + '://' + window.location.host + "/";
    {% else %}
        var ws_path = ws_scheme + '://' + window.location.host + ":8001/"; // PRODUCTION
    {% endif %}

    var notificationSocket = new WebSocket(ws_path);

    notificationSocket.onmessage = function(message) {
        var data = JSON.parse(message.data);
        //console.log(data)
        //console.log("Got general notification websocket message. " + data.general_msg_type);
        //console.log("Got chat notification websocket message. " + data.chat_msg_type);

        /*
            GENERAL NOTIFICATIONS
        */
        // new 'general' notifications data payload
        if(data.general_msg_type == 0){
            handleGeneralNotificationsData(data['notifications'], data['new_page_number'])
        }

        // "General" Pagination exhausted. No more results.
        if(data.general_msg_type == 1){
            setGeneralPaginationExhausted()
        }

        // Refresh [newest_timestamp >= NOTIFICATIONS >= oldest_timestamp]
        if(data.general_msg_type == 2){
            refreshGeneralNotificationsData(data['notifications'])
        }

        if(data.general_msg_type == 3){
            handleNewGeneralNotificationsData(data['notifications'])
        }

        if(data.general_msg_type == 4){
            setUnreadGeneralNotificationsCount(data['count'])
        }

        if(data.general_msg_type == 5){
            updateGeneralNotificationDiv(data['notification'])
        }

        /*
            CHAT NOTIFICATIONS
        */
        // new 'chat' notifications data payload
        if(data.chat_msg_type == 10){
            handleChatNotificationsData(data['notifications'], data['new_page_number'])
        }
        // "Chat" Pagination exhausted. No more results.
        if(data.chat_msg_type == 11){
            setChatPaginationExhausted()
        }
        // refreshed chat notifications
        if(data.chat_msg_type == 13){
            handleNewChatNotificationsData(data['notifications'])
        }
        if(data.chat_msg_type == 14){
            setChatNotificationsCount(data['count'])
        }
    }

    notificationSocket.onclose = function(e) {
        console.error('Notification Socket closed unexpectedly');
    };

    notificationSocket.onopen = function(e){
        //console.log("Notification Socket on open: " + e)
        setupGeneralNotificationsMenu()
        getFirstGeneralNotificationsPage()
        getUnreadGeneralNotificationsCount()

        setupChatNotificationsMenu()
        getFirstChatNotificationsPage()
    }

    notificationSocket.onerror = function(e){
        console.log('Notification Socket error', e)
    }

    if (notificationSocket.readyState == WebSocket.OPEN) {
        //console.log("Notification Socket OPEN complete.")
    } 
    else if (notificationSocket.readyState == WebSocket.CONNECTING){
        //console.log("Notification Socket connecting..")
    }

    // chat notifications
    
    setOnChatNotificationScrollListener()
    onChatNotificationsPaginationTriggerListener()

    const CHAT_NOTIFICATION_INTERVAL = 4000
    var chatCachedNotifList = new List([])

    function submitNewChatNotificationToCache(notification){
        var result = chatCachedNotifList.filter(function(n){ 
            return n['notification_id'] === notification['notification_id']
        })
        // This notification does not already exist in the list
        if(result.length == 0){
            chatCachedNotifList.push(notification)

            // append to top of list
            appendTopChatNotification(notification)
        }
        // This notification already exists in the list
        else{
            // find the div and update it.
            refreshChatNotificationsList(notification)
        }
    }

    function submitChatNotificationToCache(notification){
        var result = chatCachedNotifList.filter(function(n){ 
            return n['notification_id'] === notification['notification_id']
        })
        // This notification does not already exist in the list
        if(result.length == 0){
            chatCachedNotifList.push(notification)

            // append to bottom of list
            appendBottomChatNotification(notification)
        }
        // This notification already exists in the list
        else{
            // find the div and update it.
            refreshChatNotificationsList(notification)
        }
    }

    function handleNewChatNotificationsData(notifications){
        if(notifications.length > 0){
            clearNoChatNotificationsCard()
            notifications.forEach(notification => {

                submitNewChatNotificationToCache(notification)

                setChatNewestTimestamp(notification['timestamp'])
            })
        }
    }

    function setChatNewestTimestamp(timestamp){
        element = document.getElementById("id_chat_newest_timestamp")
        current = element.innerHTML
        if(Date.parse(timestamp) > Date.parse(current)){
            element.innerHTML = timestamp
        }
        else if(current == "" || current == null || current == "undefined"){
            element.innerHTML = timestamp
        }
        //console.log("setChatNewestTimestamp: " + element.innerHTML)
    }

    function setupChatDropdownHeader(){
        var notificationContainer = document.getElementById("id_chat_notifications_container")

        if(notificationContainer != null){

            var div = document.createElement("div")
            div.classList.add("chat-dropdown-header", "d-flex", "flex-row", "justify-content-end", "m-auto", "align-items-end")

        }
    }

    function chatRedirect(url){
        window.location.href = url
    }

    function setupChatNotificationsMenu(){
        var notificationContainer = document.getElementById("id_chat_notifications_container")

        if(notificationContainer != null){
            setupChatDropdownHeader()

            card = createChatNotificationCard("id_no_chat_notifications")

            var div = document.createElement("div")
            div.classList.add("d-flex", "flex-row", "align-items-start")

            span = document.createElement("span")
            span.classList.add("align-items-start", "pt-1", "m-auto")
            span.innerHTML = "You have no notifications."
            div.appendChild(span)
            card.appendChild(div)
            notificationContainer.appendChild(card)

            setChatNotificationsCount([])
        }
    }

    function clearNoChatNotificationsCard(){
        var element = document.getElementById("id_no_chat_notifications")
        if(element != null && element != "undefined"){
            document.getElementById("id_chat_notifications_container").removeChild(element)
        }
    }

    function createChatNotificationCard(cardId){
        var card = document.createElement("div")
        if(cardId != "undefined"){
            card.id = cardId
        }
        card.classList.add("d-flex", "flex-column", "align-items-start", "chat-card","p-4")
        card.style = "width: 100%"
        return card
    }

    function createChatProfileImageThumbnail(notification){
        img = document.createElement("img")
        img.classList.add("notification-thumbnail-image", "img-fluid", "rounded-circle", "mr-2")
        img.src = notification['from']['image_url']
        img.id = assignChatImgId(notification['notification_id'])
        return img
    }

    function createChatTimestampElement(notification){
        var timestamp = document.createElement("p")
        timestamp.classList.add("small", "pt-2", "timestamp-text")
        timestamp.innerHTML = notification['natural_timestamp']
        timestamp.id = assignChatTimestampId(notification)
        return timestamp
    }

    function createUnreadChatRoomMessagesElement(notification){
        card = createChatNotificationCard()
        card.id = assignChatCardId(notification)
        card.addEventListener("click", function(){
            //chatRedirect(notification['actions']['redirect_url'])
            user_id = document.getElementById('user_id').innerHTML
            a = notification['from'].image_url
            a = a.replace(window.location.origin,'')
            this_user_id = a.split('/')[3]
            redirect('messages', user_id, this_user_id)
            Messenger('On');
        })

        var div1 = document.createElement("div")
        div1.classList.add("d-flex", "flex-row", "align-items-start")
        div1.id = assignChatDiv1Id(notification)

        img = createChatProfileImageThumbnail(notification)
        img.id = assignChatImgId(notification)
        div1.appendChild(img)

        var div2 = document.createElement("div")
        div2.classList.add("d-flex", "flex-column")
        div2.id = assignChatDiv2Id(notification)
        
        var title = document.createElement("span")
        title.classList.add("align-items-start")
        title.innerHTML = notification['from']['title']
        title.id = assignChatTitleId(notification)
        div2.appendChild(title)

        var chatRoomMessage = document.createElement("span")
        chatRoomMessage.id = assignChatroomMessageId(notification)
        chatRoomMessage.classList.add("align-items-start", "pt-1", "small", "notification-chatroom-msg")
        if(notification['verb'].length > 50){
            chatRoomMessage.innerHTML = notification['verb'].slice(0, 50) + "..."
        }
        else{
            chatRoomMessage.innerHTML = notification['verb']
        }
        div2.appendChild(chatRoomMessage)
        div1.appendChild(div2)
        card.appendChild(div1)
        card.appendChild(createChatTimestampElement(notification))
        return card
    }

    function appendTopChatNotification(notification){
        switch(notification['notification_type']) {

            case "UnreadChatRoomMessages":
                chatNotificationContainer = document.getElementById("id_chat_notifications_container")
                card = createUnreadChatRoomMessagesElement(notification)

                if(chatNotificationContainer.childNodes.length > 2){
                    // Append as the SECOND child. First child is the "go to chatroom" button
                    // var index = chatNotificationContainer.childNodes.length - 1
                    var index = 2
                    chatNotificationContainer.insertBefore(card, chatNotificationContainer.childNodes[index]);
                }
                else {
                    chatNotificationContainer.appendChild(card)
                }
                
                break;

            default:
                // code block
        }
    }

    function appendBottomChatNotification(notification){

        switch(notification['notification_type']) {

            case "UnreadChatRoomMessages":
                chatNotificationContainer = document.getElementById("id_chat_notifications_container")
                card = createUnreadChatRoomMessagesElement(notification)
                chatNotificationContainer.appendChild(card)
                break;

            default:
                // code block
        }
    }

    function handleChatNotificationsData(notifications, new_page_number){
        if(notifications.length > 0){
            clearNoChatNotificationsCard()
            
            notifications.forEach(notification => {

                submitChatNotificationToCache(notification)

                setChatNewestTimestamp(notification['timestamp'])
            })
            setChatPageNumber(new_page_number)
        }
    }

    function refreshChatNotificationsList(notification){
        notificationContainer = document.getElementById("id_chat_notifications_container")

        if(notificationContainer != null){
            divs = notificationContainer.childNodes

            divs.forEach(function(card){
                // card
                if(card.id == ("id_notification_" + notification['notification_id'])){
                    
                    if(notification['notification_type'] == "UnreadChatRoomMessages"){
                        refreshUnreadChatRoomMessagesCard(card, notification)
                    }
                }
            })
        }
    }

    function refreshUnreadChatRoomMessagesCard(card, notification){

        card.childNodes.forEach(function(element){

            // DIV1
            if(element.id == ("id_chat_div1_" + notification['notification_id'])){
                element.childNodes.forEach(function(child){

                    // DIV2
                    if(child.id == ("id_chat_div2_" + notification['notification_id'])){
                        child.childNodes.forEach(function(nextChild){
                            if(nextChild.id == ("id_chat_title_" + notification['notification_id'])){
                                // found title
                                nextChild.innerHTML = notification['from']['title']
                            }
                            if(nextChild.id == ("id_chat_message_" + notification['notification_id'])){
                                // found chat message
                                if(notification['verb'].length > 50){
                                    nextChild.innerHTML = notification['verb'].slice(0, 50) + "..."
                                }
                                else{
                                    nextChild.innerHTML = notification['verb']
                                }
                            }
                        })
                    }
                })
            }

            // TIMESTAMP
            if (element.id == ("id_timestamp_" + notification['notification_id'])){
                element.innerHTML = notification['natural_timestamp']
            }
        })
    }

    function setChatPaginationExhausted(){
        setChatPageNumber("-1")
    }

    function setChatPageNumber(pageNumber){
        document.getElementById("id_chat_page_number").innerHTML = pageNumber
    }

    function onChatNotificationsPaginationTriggerListener(){
        window.onscroll = function(ev) {
            // because of rounding we need to add 2. 1 might be OK but I'm using 2.
            if ((window.innerHeight + window.scrollY + 2) >= document.body.scrollHeight) {
                getNextChatNotificationsPage()
            }
        };
    }

    function setOnChatNotificationScrollListener(){
        var menu = document.getElementById("id_chat_notifications_container")
        if(menu != null ){
            menu.addEventListener("scroll", function(e){

                if ((menu.scrollTop) >= (menu.scrollHeight - menu.offsetHeight)) {
                    getNextChatNotificationsPage()
                }
            });
        }
        
    }

    function setChatNotificationsCount(count){
        var countElement = document.getElementById("id_chat_notifications_count")
        if(count > 0){
            countElement.style.display = "contents"
            countElement.innerHTML = count
        }
        else{
            countElement.style.background = "transparent"
            countElement.style.display = "none"
        }
    }

    function getUnreadChatNotificationsCount(){
        if("{{request.user.is_authenticated}}"){
            notificationSocket.send(JSON.stringify({
                "command": "get_unread_chat_notifications_count",
            }));
        }
    }

    function getNextChatNotificationsPage(){
        var pageNumber = document.getElementById("id_chat_page_number").innerHTML
        // -1 means exhausted or a query is currently in progress
        if("{{request.user.is_authenticated}}" && pageNumber != "-1"){
            notificationSocket.send(JSON.stringify({
                "command": "get_chat_notifications",
                "page_number": pageNumber,
            }));
        }
    }
    
    function getNewChatNotifications(){
        newestTimestamp = document.getElementById("id_chat_newest_timestamp").innerHTML
        //console.log("NEWEST TS: " + newestTimestamp)
        if("{{request.user.is_authenticated}}"){
            notificationSocket.send(JSON.stringify({
                "command": "get_new_chat_notifications",
                "newest_timestamp": newestTimestamp,
            }));
        }
    }

    function getFirstChatNotificationsPage(){
        if("{{request.user.is_authenticated}}"){
            notificationSocket.send(JSON.stringify({
                "command": "get_chat_notifications",
                "page_number": "1",
            }));
            getUnreadChatNotificationsCount()
        }
    }

    function startChatNotificationService(){
        if("{{request.user.is_authenticated}}" == "True"){
            setInterval(getNewChatNotifications, CHAT_NOTIFICATION_INTERVAL)
            setInterval(getUnreadChatNotificationsCount, CHAT_NOTIFICATION_INTERVAL)
        }
    }

    startChatNotificationService()

    function assignChatDiv1Id(notification){
        return "id_chat_div1_" + notification['notification_id']
    }

    function assignChatImgId(notification){
        return "id_chat_img_" + notification['notification_id']
    }

    function assignChatTitleId(notification){
        return "id_chat_title_" + notification['notification_id']
    }

    function assignChatroomMessageId(notification){
        return "id_chat_message_" + notification['notification_id']
    }

    function assignChatDiv2Id(notification){
        return "id_chat_div2_" + notification['notification_id']
    }

    function assignChatTimestampId(notification){
        return "id_timestamp_" + notification['notification_id']
    }

    function assignChatCardId(notification){
        return "id_notification_" + notification['notification_id']
    }

    function setChatInitialTimestamp(){
        // ('%Y-%m-%d %H:%M:%S.%f')
        var today = new Date();
        var date = today.getFullYear() + "-01-01 01:00:00.000000"
        document.getElementById("id_chat_newest_timestamp").innerHTML = date
    }

    setChatInitialTimestamp() 

    // chat messages and notifications

    var chatSocket = null;
    var roomId = null;

    function ChatMessagesAndNotificationsOnStart(){
        {% if m_and_f %}
            onSelectFriend("{{m_and_f.0.friend.id}}")
        {% endif %}
        {% for x in m_and_f %}
            preloadImage("{{x.friend.profile_image.url|safe}}", "id_friend_img_{{x.friend.id}}")
        {% endfor %}
    }

    function messagesSend() {
        const messageInputDom = document.getElementById('id_chat_message_input');
        const message = messageInputDom.value;
        chatSocket.send(JSON.stringify({
            "command": "send",
            "message": message,
            "room": roomId
        }));
        messageInputDom.value = '';
    }

    function messageFrom(this_user_id) {
        const user_id = document.getElementById('user_id').innerHTML
        page = 'messages'
        redirect(page, user_id, this_user_id)
        Messenger('On');
    }

    function onSelectFriend(id){
        payload = {
            "csrfmiddlewaretoken": "{{ csrf_token }}",
            "user2_id": id,
        }
        $.ajax({
            type: 'POST',
            dataType: "json",
            url: "{% url 'create-or-return-private-chat' %}", // production
            data: payload,
            timeout: 5000,
            success: function(data) {
                //console.log("SUCCESS", data)
                if(data['response'] == "Successfully got the chat."){
                    setupWebSocket(data['chatroom_id'])
                }
                else if(data['response'] != null){
                    alert(data['response'])
                }
            },
            error: function(data) {
                console.error("ERROR...", data)
                alert("Something went wrong.")
            },
        });
        clearHighlightedFriend();
        highlightFriend(id);
        Messenger('On');
    }

    function closeWebSocket(){
        if(chatSocket != null){
            chatSocket.close()
            chatSocket = null
            clearChatLog()
            setPageNumber("1")
            disableChatLogScrollListener()
        }
    }

    function setupWebSocket(room_id){

        //console.log("setupWebSocket: " + room_id)

        roomId = room_id

        // close previous socket if one is open
        closeWebSocket()

        // Correctly decide between ws:// and wss://
        var ws_scheme = window.location.protocol == "https:" ? "wss" : "ws";
        {% if debug_mode %}
            var ws_path = ws_scheme + '://' + window.location.host + "/chat/" + roomId + "/"; // development
        {% else %}
            var ws_path = ws_scheme + '://' + window.location.host + ":8001/chat/" + roomId + "/"; // production
        {% endif %}
        
        // console.log("Connecting to " + ws_path);
        chatSocket = new WebSocket(ws_path);

        // Handle incoming messages
        chatSocket.onmessage = function(message) {
            // Decode the JSON
            // console.log("Got chat websocket message " + message.data);
            //console.log("Got websocket message.");
            var data = JSON.parse(message.data);

            // display the progress bar?
            displayChatroomLoadingSpinner(data.display_progress_bar)

            // Handle errors (ClientError)
            if (data.error) {
                console.error(data.error + ": " + data.message)
                showClientErrorModal(data.message)
                return;
            }
            // Handle joining (Client perspective)
            if (data.join) {
                //console.log("Joining room " + data.join);
                getUserInfo()
                getRoomChatMessages()
                enableChatLogScrollListener()
            }
            // Handle leaving (client perspective)
            if (data.leave) {
                // do nothing
                //console.log("Leaving room " + data.leave);
            }

            // user info coming in from backend
            if(data.user_info){
                handleUserInfoPayload(data.user_info)
            }

            // Handle getting a message
            if (data.msg_type == 0 || data.msg_type == 1 || data.msg_type == 2) {
                appendChatMessage(data, false, true)
            }

            // new payload of messages coming in from backend
            if(data.messages_payload){
                handleMessagesPayload(data.messages, data.new_page_number)
            }
        };

        chatSocket.addEventListener("open", function(e){
            //console.log("ChatSocket OPEN")
            // join chat room
            if("{{request.user.is_authenticated}}"){
                chatSocket.send(JSON.stringify({
                    "command": "join",
                    "room": roomId
                }));
            }
        })

        chatSocket.onclose = function(e) {
            //console.log('Chat socket closed.');
        };

        chatSocket.onOpen = function(e){
            //console.log("ChatSocket onOpen", e)
        }

        chatSocket.onerror = function(e){
            //console.log('ChatSocket error', e)
        }

        if (chatSocket.readyState == WebSocket.OPEN) {
            //console.log("ChatSocket OPEN")
        } else if (chatSocket.readyState == WebSocket.CONNECTING){
            //console.log("ChatSocket connecting..")
        }
    }

    function getUserInfo(){
        chatSocket.send(JSON.stringify({
            "command": "get_user_info",
            "room_id": roomId,
        }));
    }

    function handleUserInfoPayload(user_info){
        document.getElementById("id_other_username").innerHTML = user_info['username']
        document.getElementById("id_other_user_profile_image").classList.remove("d-none")
        document.getElementById("id_user_info_container").href= "/" + user_info['id'] + '/profile/'
        preloadImage(user_info['profile_image'], "id_other_user_profile_image")
    }

    function showClientErrorModal(message){
        document.getElementById("id_client_error_modal_body").innerHTML = message
        document.getElementById("id_trigger_client_error_modal").click()
    }

    function appendChatMessage(data, maintainPosition, isNewMessage){
        messageType = data['msg_type']
        msg_id = data['msg_id']
        message = data['message']
        uName = data['username']
        user_id = data['user_id']
        profile_image = data['profile_image']
        timestamp = data['natural_timestamp']
        //console.log("append chat message: " + messageType)
        
        var msg = "";
        var username = ""

        // determine what type of msg it is
        switch (messageType) {
            case 0:
                // new chatroom msg
                username = uName + ": "
                msg = message + '\n'
                createChatMessageElement(msg, msg_id, username, profile_image, user_id, timestamp, maintainPosition, isNewMessage)
                break;
            case 1:
                // User joined room
                createConnectedDisconnectedElement(message, msg_id, profile_image, user_id)
                break;
            case 2:
                // User left room
                createConnectedDisconnectedElement(message, msg_id, profile_image, user_id)
                break;
            default:
                console.log("Unsupported message type!");
                return;
        }
    }

    function createChatMessageElement(msg, msg_id, username, profile_image, user_id, timestamp, maintainPosition, isNewMessage){
        var chatLog = document.getElementById("id_chat_log")

        var newMessageDiv = document.createElement("div")
        newMessageDiv.classList.add("d-flex")
        newMessageDiv.classList.add("flex-row")
        newMessageDiv.classList.add("message-container")

        var profileImage = document.createElement("img")
        profileImage.addEventListener("click", function(e){
            selectUser(user_id)
        })
        profileImage.classList.add("profile-image-messages")
        profileImage.classList.add("rounded-circle")
        profileImage.classList.add("img-fluid")
        var profileImageSrc = "{% static 'clockdb/dummy_image.png' %}".replace(/&amp;/g, "&")
        profileImage.src = profileImageSrc
        var profile_image_id = "id_profile_image_" + msg_id
        profileImage.id = profile_image_id
        newMessageDiv.appendChild(profileImage)

        var div1 = document.createElement("div")
        div1.classList.add("d-flex")
        div1.classList.add("flex-column")

        var div2 = document.createElement("div")
        div2.classList.add("d-flex")
        div2.classList.add("flex-row")

        var usernameSpan = document.createElement("span")
        usernameSpan.innerHTML = username
        usernameSpan.classList.add("username-span-messages")
        usernameSpan.addEventListener("click", function(e){
            selectUser(user_id)
        })
        div2.appendChild(usernameSpan)

        var timestampSpan = document.createElement("span")
        timestampSpan.innerHTML = timestamp
        timestampSpan.classList.add("timestamp-span")
        timestampSpan.classList.add("d-flex")
        timestampSpan.classList.add("align-items-center")
        timestampSpan.addEventListener("click", function(e){
            selectUser(user_id)
        })
        div2.appendChild(timestampSpan)

        div1.appendChild(div2)

        var msgP = document.createElement("p")
        msgP.innerHTML = validateText(msg)
        msgP.style="line-break: normal;"
        div1.appendChild(msgP)

        newMessageDiv.appendChild(div1)

        if(isNewMessage){
            chatLog.insertBefore(newMessageDiv, chatLog.firstChild)
        }
        else{
            chatLog.appendChild(newMessageDiv)
        }
        
        if(!maintainPosition){
            chatLog.scrollTop = chatLog.scrollHeight
        }

        preloadImage(profile_image, profile_image_id)
    }

    function createConnectedDisconnectedElement(msg, msd_id, profile_image, user_id){
        var chatLog = document.getElementById("id_chat_log")

        var newMessageDiv = document.createElement("div")
        newMessageDiv.classList.add("d-flex")
        newMessageDiv.classList.add("flex-row")
        newMessageDiv.classList.add("message-container")

        var profileImage = document.createElement("img")
        profileImage.addEventListener("click", function(e){
            selectUser(user_id)
        })
        profileImage.classList.add("profile-image-messages")
        profileImage.classList.add("rounded-circle")
        profileImage.classList.add("img-fluid")
        var profileImageSrc = "{% static 'clockdb/dummy_image.png' %}".replace(/&amp;/g, "&")
        profileImage.src = profileImageSrc
        var profile_image_id = "id_profile_image_" + msg_id
        profileImage.id = profile_image_id
        newMessageDiv.appendChild(profileImage)

        var usernameSpan = document.createElement("span")
        usernameSpan.innerHTML = msg
        usernameSpan.classList.add("username-span-messages")
        usernameSpan.addEventListener("click", function(e){
            selectUser(user_id)
        })
        newMessageDiv.appendChild(usernameSpan)

        chatLog.insertBefore(newMessageDiv, chatLog.firstChild)

        preloadImage(profile_image, profile_image_id)
    }

    function setPageNumber(pageNumber){
        document.getElementById("id_page_number").innerHTML = pageNumber
    }

    function clearChatLog(){
        document.getElementById("id_chat_log").innerHTML = ""
    }

    function setPaginationExhausted(){
        setPageNumber("-1")
    }

    function getRoomChatMessages(){
        var pageNumber = document.getElementById("id_page_number").innerHTML
        if(pageNumber != "-1"){
            setPageNumber("-1") // loading in progress
            chatSocket.send(JSON.stringify({
                "command": "get_room_chat_messages",
                "room_id": roomId,
                "page_number": pageNumber,
            }));
        }
    }

    function handleMessagesPayload(messages, new_page_number){
        if(messages != null && messages != "undefined" && messages != "None"){
            setPageNumber(new_page_number)
            messages.forEach(function(message){
                appendChatMessage(message, true, false)
            })
        }
        else{
            setPaginationExhausted() // no more messages
        }
    }

    function selectUser(user_id){
        // Weird work-around for passing arg to url
        //var win = window.open(url, "_blank")
        //win.focus()
    }

    function chatLogScrollListener(e) {
        var chatLog = document.getElementById("id_chat_log")
        if ((Math.abs(chatLog.scrollTop) + 2) >= (chatLog.scrollHeight - chatLog.offsetHeight)) {
            getRoomChatMessages()
        }
    }

    function enableChatLogScrollListener(){
        document.getElementById("id_chat_log").addEventListener("scroll", chatLogScrollListener);
    }

    function disableChatLogScrollListener(){
        document.getElementById("id_chat_log").removeEventListener("scroll", chatLogScrollListener)
    }

    function displayChatroomLoadingSpinner(isDisplayed){
        //console.log("displayChatroomLoadingSpinner: " + isDisplayed)
        var spinner = document.getElementById("id_chatroom_loading_spinner")
        if(isDisplayed){
            spinner.style.display = "block"
        }
        else{
            spinner.style.display = "none"
        }
    }

    function highlightFriend(userId){
        // select new friend
        document.getElementById("id_friend_container_" + userId).style.background = "#f2f2f2"
    }

    function clearHighlightedFriend(){
        {% if m_and_f %}
            {% for x in m_and_f %}
                document.getElementById("id_friend_container_{{x.friend.id}}").style.background = ""
            {% endfor %}
        {% endif %}

        // clear the profile image and username of current chat
        document.getElementById("id_other_user_profile_image").classList.add("d-none")
        var profileImageSrc = "{% static 'clockdb/dummy_image.png' %}".replace(/&amp;/g, "&")
        document.getElementById("id_other_user_profile_image").src = profileImageSrc
        document.getElementById("id_other_username").innerHTML = ""
    }

    function messageInputFocus() {
        a = document.getElementById('id_chat_message_input')
        a.focus()
    }

    // friends requests
    
    function onFriendRequestAccepted(){
        location.reload();
    }

    function onFriendRequestDeclined(){
        location.reload();
    }

    function triggerAcceptFriendRequest(friend_request_id){
        acceptFriendRequest(friend_request_id, onFriendRequestAccepted)
    }

    function triggerDeclineFriendRequest(friend_request_id){
        declineFriendRequest(friend_request_id, onFriendRequestDeclined)
    }

    function onFriendRemoved(){
        location.reload();
    }

    function onFriendRequestAccepted(){
        location.reload();
    }

    function onFriendRequestDeclined(){
        location.reload();
    }

    function onFriendRequestSent(){
        location.reload();
    }

    function onFriendRequestCancelled(){
        location.reload();
    }

    function sendFriendRequest(id){
        payload = {
            "csrfmiddlewaretoken": "{{ csrf_token }}",
            "receiver_user_id": id,
        }
        $.ajax({
            type: 'POST',
            dataType: "json",
            url: "{% url 'friend-request' %}",
            timeout: 5000,
            data: payload,
            success: function(data) {
                //console.log("SUCCESS", data)
                if(data['response'] == "Friend request sent."){
                    // ui is updated
                }
                else if(data['response'] != null){
                    alert(data['response'])
                }
            },
            error: function(data) {
                console.error("ERROR...", data)
                alert("Something went wrong.")
            },
            complete: function(data){}
        });
    }

    function cancelFriendRequest(id){
        payload = {
            "csrfmiddlewaretoken": "{{ csrf_token }}",
            "receiver_user_id": id,
        }
        $.ajax({
            type: 'POST',
            dataType: "json",
            url: "{% url 'friend-request-cancel' %}",
            data: payload,
            timeout: 5000,
            success: function(data) {
                //console.log("SUCCESS", data)
                if(data['response'] == "Friend request canceled."){
                    // ui is updated
                }
                else if(data['response'] != null){
                    alert(data['response'])
                }
            },
            error: function(data) {
                console.error("ERROR...", data)
                alert("Something went wrong.")
            },
            complete: function(data){}
        });
    }

    try {
        var removeFriendBtn = document.getElementById("id_unfriend_btn")
        if (removeFriendBtn != null){
            removeFriendBtn.addEventListener("click", function(){
                removeFriend("{{id}}", onFriendRemoved)
            })
        }
    } catch {}

    function removeFriend(id, uiUpdateFunction){
        payload = {
            "csrfmiddlewaretoken": "{{ csrf_token }}",
            "receiver_user_id": id,
        }
        $.ajax({
            type: 'POST',
            dataType: "json",
            timeout: 5000,
            url: "{% url 'remove-friend' %}",
            data: payload,
            success: function(data) {
                //console.log("SUCCESS", data)
                if(data.response == "Successfully removed that friend."){
                    // UI gets updated
                }
                else if(data.response != null){
                    alert(data.response)
                }
            },
            error: function(data) {
                console.error("ERROR...", data)
                alert("Something went wrong." + data)
            },
            complete: function(data){
                uiUpdateFunction()
            }
        });
    }

    function triggerAcceptFriendRequest(friend_request_id){
        acceptFriendRequest(friend_request_id, onFriendRequestAccepted)
    }

    function acceptFriendRequest(friend_request_id, uiUpdateFunction){
        var url = "{% url 'friend-request-accept' friend_request_id=53252623623632623 %}".replace("53252623623632623", friend_request_id)
        $.ajax({
            type: 'GET',
            dataType: "json",
            url: url,
            timeout: 5000,
            success: function(data) {
                //console.log("SUCCESS", data)
                if(data['response'] == "Friend request accepted."){
                    // ui is updated
                }
                else if(data['response'] != null){
                    alert(data['response'])
                }
            },
            error: function(data) {
                console.error("ERROR...", data)
                alert("Something went wrong: " + data)
            },
            complete: function(data){
                uiUpdateFunction()
            }
        });
    }

    function triggerDeclineFriendRequest(friend_request_id){
        declineFriendRequest(friend_request_id, onFriendRequestDeclined)
    }

    function declineFriendRequest(friend_request_id, uiUpdateFunction){
    var url = "{% url 'friend-request-decline' friend_request_id=53252623623632623 %}".replace("53252623623632623", friend_request_id)
    $.ajax({
        type: 'GET',
        dataType: "json",
        url: url,
        timeout: 5000,
        success: function(data) {
            //console.log("SUCCESS", data)
            if(data['response'] == "Friend request declined."){
                // ui is updated
            }
            else if(data['response'] != null){
                alert(data['response'])
            }
        },
        error: function(data) {
            console.error("ERROR...", data)
            alert("Something went wrong: " + data)
        },
        complete: function(data){
            uiUpdateFunction()
        }
    });
}
    
    function friendRequestButtonsOnStart() {
        FR = "{{ friends_requests }}"
        FR = FR.replace('[','')
        FR = FR.replace(']','')
        i = 0
        id = 0
        while (id != undefined) {
            try {
                id = FR.split(', ')[i]
                document.getElementsByName(id)[0].innerHTML = 'Cancel Friend Request';
                document.getElementsByName(id)[0].id = 'id_cancel_friend_request_btn_profiles';
                document.getElementsByName(id)[0].className = 'btn btn-danger';
                document.getElementsByName(id)[1].innerHTML = 'Cancel Friend Request';
                document.getElementsByName(id)[1].id = 'id_cancel_friend_request_btn_profiles';
                document.getElementsByName(id)[1].className = 'btn btn-danger';
            } catch {}
            i = i + 1
        }
    }
    
    // on load
    function onePageAppOnLoad(hideIf) {
        const user_id = document.getElementById('user_id').innerHTML
        var page = window.location.pathname.replace('/','').split('/')[1];
        if (user_id != '') {
            document.querySelectorAll('div').forEach(div => {
                hideDiv(div);
            });
            document.querySelectorAll('button').forEach(button => {
                onePageApp(button);
            })
            // Ï†
            if (page == 'WorkingPaper') {
                var subpage = window.location.href.replace(window.location.origin,'').split('/')[4]
                if (subpage == '') {
                    subpage = 'Opinion'
                }
                showPage(subpage)
                Compile();
                ts = document.getElementById('TradingSymbol1').value;
                document.title = 'Clockdb | ' + ts + ' | '+ subpage;
                page = subpage
                history.pushState({page}, ``, `/${user_id}/WorkingPaper/${ts}/${page}/`);
            // Posts
            } else {
                // phase
                if (page == 'phase') {
                    url = window.location.origin + '/'
                    window.open(url, '_self');
                }
                // home
                home = [
                    undefined,
                    '',
                    'home',
                    'Home',
                ]
                if (home.includes(page)) {
                    try {
                        a = document.getElementById('user_id').innerHTML
                        if (a != 'None') {
                            activeurl = window.location.href.replace(window.location.origin,'').replaceAll('/','')
                            activeurlsub = window.location.href.split('/')[1]
                            url = window.location.origin + '/' + a + '/Posts/'
                            if (activeurl != a) {
                                window.open(url, '_self');
                            } else {
                                page = 'Posts'
                                document.title = 'Clockdb | ' + page;
                                history.pushState({page}, ``, `/${user_id}/${page}/`);
                                showPage(page)
                            }
                        }
                    } catch {
                        url = window.location.origin + '/login'
                        window.open(url, '_self');
                    }
                // others
                } else {
                    document.title = 'Clockdb | ' + page;
                    history.pushState({page}, ``, ``);
                    showPage(page)
                }
            }
        }
    };
    
    // buttons
    function onePageApp(button) {
        button.onclick = function() {
            user_id = document.getElementById('user_id').innerHTML;
            page = this.dataset.page;
            gg = 0
            if (page != "#") {
                if (page == 'Messenger') {
                    if (localStorage.Messenger == 'On') {
                        Messenger('Off');
                    } else {
                        Messenger('On')
                    }
                    gg = 1
                }
                if (page == 'MessengerNotifications') {
                    if (localStorage.MessengerNotifications == 'On') {
                        MessengerNotifications('Off');
                    } else {
                        MessengerNotifications('On');
                    }
                    gg = 1
                }
                if (page == 'Notifications') {
                    if (localStorage.Notifications == 'On') {
                        Notifications('Off')
                    } else {
                        Notifications('On')
                    }
                    setGeneralNotificationsAsRead();
                    gg = 1
                }
                if (page == 'SortAndOrder') {
                    SortAndOrder(button.id);
                    gg = 1
                }
                if (page == 'Print') {
                    Print();
                    gg = 1
                }
                if (page == 'UploadConfirm') {
                    UploadConfirm();
                    gg = 1
                }
                if (page == 'Save') {
                    Save();
                    gg = 1
                }
                if (page == 'Rollover') {
                    Rollover();
                    gg = 1
                }
                if (page == 'ClearCheckboxes') {
                    ClearCheckboxes();
                    gg = 1
                }
                if (page == 'OpenEditor') {
                    OpenEditor();
                    gg = 1
                }
                if (page == 'UnhideCheckbox') {
                    UnhideCheckbox();
                    gg = 1
                }
                id = this.id
                if (id.slice(id.length - 8) == 'ShortCut') {
                    position = button.className
                    ShortCuts(id, page, position);
                    gg = 1
                }
                if (page.slice(-5) == 'Files') {
                    FilesPage(page);
                    gg = 1
                }
                if (page == 'ReferenceHeader') {
                    thisHeader = this
                    ReferenceHeaderButton(thisHeader)
                    gg = 1
                }
                if (page == 'search_posts') {
                    showPage('Posts');
                    historyPush('Posts');
                    ClearPosts();
                    Posts();
                    gg = 1
                }
                if (page == 'Control') {
                    if (localStorage.Control == 'On') {
                        Control('Off');
                    } else {
                        Control('On');
                    }
                    gg = 1
                }
                if (page == 'change_password') {
                    url = window.location.origin + '/' + user_id + '/change_password/';
                    window.open(url, '_self');
                }
                if (page == 'messages') {
                    const user_id = document.getElementById('user_id').innerHTML
                    const this_user_id = button.name.replace('messageTo','')
                    redirect(page, user_id, this_user_id)
                    Messenger('On');
                    gg = 1
                }
                if (page == 'CloseControl') {
                    Control('Off');
                    gg = 1
                }
                if (page == 'CloseMessenger') {
                    Messenger('Off');
                    gg = 1
                }
                if (page == 'friend_request') {
                    id = button.name
                    classB = button.className
                    if (classB == 'btn btn-primary') {
                        sendFriendRequest(id)
                    }
                    if (classB == 'btn btn-danger') {
                        cancelFriendRequest(id)
                    }
                    toggleButton(id, classB)
                    gg = 1
                }
                if (page == 'send_message') {
                    messagesSend();
                    gg = 1
                }
                if (page == 'New') {
                    url = window.location.origin + '/' + user_id + '/WorkingPaper/MODEL';
                    window.open(url, '_self');
                }
                if (page == 'Save') {
                    Save()
                    gg = 1
                }
                if (page == 'Logout') {
                    url = window.location.origin + '/logout';
                    window.open(url, '_self');
                }
                home = [
                    '',
                    'Home',
                ]
                if (home.includes(page)) {
                    page == 'Home'
                }
                if (page == 'Home') {
                    try {
                        a = document.getElementById('Authenticated')
                        showPage(page)
                        gg = 1
                    } catch {
                        url = window.location.origin + '/login/'
                        window.open(url, '_self');
                    }
                }
                if (page == 'Posts') {
                    PostsUrl()
                }
                profile = [
                    'profile',
                ]
                if (profile.includes(page)) {
                    redirect(page, user_id)
                    gg = 1
                }
                if (gg < 1) {
                    showPage(page);
                    historyPush(page);
                    Compile();
                }
            }
        }
    };

</script>
<!-- endblock -->
{% endblock content %}




