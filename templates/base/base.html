{% load static %}
<!-- html -->
<!DOCTYPE html>
<html lang=en>
	<!-- head -->
	<head>
		<!-- Required meta tags -->
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		<link rel="stylesheet" href="{% static 'bootstrap/css/bootstrap.min.css' %}">
		<link href="https://fonts.googleapis.com/css2?family=Material+Icons" rel="stylesheet">
		<!-- favicon -->
		<link rel="shortcut icon" href="{% static 'clockdb/favicon.ico' %}">
		<link rel="icon" href="{% static 'clockdb/favicon.ico' %}" type="image/x-icon">
		<!-- Cropperjs -->
		<!--
		<link rel="stylesheet" href="{% static 'cropperjs/dist/cropper.min.css' %}">
		 -->
		<!-- Markdown-it -->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/markdown-it/11.0.1/markdown-it.min.js"
			integrity="sha512-hW0KbtvDnXCHbh2UCNP/6R+oXxCKiOfm9ciuUekdGBCQF1+57bGqZAk3sAFir7PMQstyRW0UecsSc2HQotH2vg=="
			crossorigin="anonymous"></script>
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/styles/default.min.css"
			integrity="sha512-kZqGbhf9JTB4bVJ0G8HCkqmaPcRgo88F0dneK30yku5Y/dep7CZfCnNml2Je/sY4lBoqoksXz4PtVXS4GHSUzQ=="
			crossorigin="anonymous" />
		<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/highlight.min.js"
			integrity="sha512-TDKKr+IvoqZnPzc3l35hdjpHD0m+b2EC2SrLEgKDRWpxf2rFCxemkgvJ5kfU48ip+Y+m2XVKyOCD85ybtlZDmw=="
			crossorigin="anonymous"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/languages/kotlin.min.js"
			integrity="sha512-8aYTnyDstX39PHxorDD+6ROknf98Vqr5KTOjwRCl/442uAVKOpCJ5wY9I3VQ6y46rdDJKYBIglIfE2+GQk8U5Q=="
			crossorigin="anonymous"></script>
		<script> hljs.initHighlightingOnLoad(); </script>
	</head>
	<body>
		<!-- header -->
		<div class="header" style="display: none">
			{% include 'base/base_css.html' %}
			{% include 'base/header.html' %}
		</div>
		<!-- user id -->
		<i id="user_id" style="display: none;">{{request.user.id}}</i>
		<!-- panel -->
		<div class="Panel">
			<div class="panelHeader">
				{% include 'base/panelHeader.html' %}
			</div>
			<div class="Control">
				{% include 'panel/control.html' %}
			</div>
			<div class="Messenger">
				{% include 'panel/messenger.html' %}
			</div>
			<div class="MessengerNotifications">
				{% include 'panel/messengerNotifications.html' %}
			</div>
			<div class="Notifications">
				{% include 'panel/notifications.html' %}
			</div>	
		</div>
		<!-- main -->
		<div class="main">
			<!-- block content -->
			<div class="content">
				{% block content %}
				{% endblock content %}
				<!-- loading -->
				<div class="loading">
					<div id="id_loading_spinner">
						<span class="d-flex flex-row mx-auto flex-grow-1 justify-content-center">
							<span class="spinner-border text-primary" role="status">
								<span class="sr-only">Loading...</span>
							</span>
						</span>
					</div>
				</div>
			</div>
			<!-- footer -->
			{% include 'base/footer.html' %}
		</div>
		<!-- collections -->
		<script src="{% static 'collections/collections.min.js' %}"></script>
		<!-- jquery -->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.js"
			integrity="sha512-WNLxfP/8cVYL9sj8Jnp6et0BkubLP31jhTG9vhL/F5uEZmg5wEzKoXp1kJslzPQWwPT1eyMiSxlKCgzHLOTOTQ=="
			crossorigin="anonymous"></script>
		<!-- ajax chart -->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.1.3/Chart.min.js"></script>
		<!-- papaparse -->
		<script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.1/papaparse.min.js"></script>
		<!-- bootstrap -->
		<script src="{% static 'bootstrap/js/bootstrap.bundle.min.js' %}"></script>
		<!--
		<script type="module" src="{% static 'cropperjs/dist/cropper.min.js' %}"></script>
		-->
		<!-- onePageApp -->
		<script>
			// js/onePageApp.js
			console.log('js/onePageApp.js')
			function onePageAppOnLoad(hideIf) {
				const user_id = document.getElementById('user_id').innerHTML
				var page = window.location.pathname.replace('/','').split('/')[1];
				if (user_id != '') {
					document.querySelectorAll('div').forEach(div => {
						hideDiv(div);
					});
					document.querySelectorAll('button').forEach(button => {
						onePageApp(button);
					})
					// Ï†
					if (page == 'WorkingPaper') {
						var subpage = window.location.href.replace(window.location.origin,'').split('/')[4]
						if (subpage == '') {
							subpage = 'Opinion'
						}
						showPage(subpage)
						Compile();
						ts = document.getElementById('TradingSymbol1').value;
						document.title = 'Clockdb | ' + ts + ' | '+ subpage;
						page = subpage
						history.pushState({page}, ``, `/${user_id}/WorkingPaper/${ts}/${page}/`);
					// Posts
					} else {
						// phase
						if (page == 'phase') {
							url = window.location.origin + '/'
							window.open(url, '_self');
						}
						// home
						home = [
							undefined,
							'',
							'home',
							'Home',
						]
						if (home.includes(page)) {
							try {
								a = document.getElementById('user_id').innerHTML
								if (a != 'None') {
									activeurl = window.location.href.replace(window.location.origin,'').replaceAll('/','')
									activeurlsub = window.location.href.split('/')[1]
									url = window.location.origin + '/' + a + '/Posts/'
									if (activeurl != a) {
										window.open(url, '_self');
									} else {
										page = 'Posts'
										document.title = 'Clockdb | ' + page;
										history.pushState({page}, ``, `/${user_id}/${page}/`);
										showPage(page)
									}
								}
							} catch {
								url = window.location.origin + '/login'
								window.open(url, '_self');
							}
						// others
						} else {
							document.title = 'Clockdb | ' + page;
							history.pushState({page}, ``, ``);
							showPage(page)
						}
					}
				}
			};
			function onePageApp(button) {
				button.onclick = function() {
					user_id = document.getElementById('user_id').innerHTML;
					page = this.dataset.page;
					gg = 0
					if (page != "#") {
						if (page == 'Messenger') {
							if (localStorage.Messenger == 'On') {
								Messenger('Off');
							} else {
								Messenger('On')
							}
							gg = 1
						}
						if (page == 'MessengerNotifications') {
							if (localStorage.MessengerNotifications == 'On') {
								MessengerNotifications('Off');
							} else {
								MessengerNotifications('On');
							}
							gg = 1
						}
						if (page == 'Notifications') {
							if (localStorage.Notifications == 'On') {
								Notifications('Off')
							} else {
								Notifications('On')
							}
							setGeneralNotificationsAsRead();
							gg = 1
						}
						if (page == 'SortAndOrder') {
							SortAndOrder(button.id);
							gg = 1
						}
						if (page == 'Print') {
							Print();
							gg = 1
						}
						if (page == 'UploadConfirm') {
							UploadConfirm();
							gg = 1
						}
						if (page == 'Save') {
							Save();
							gg = 1
						}
						if (page == 'Rollover') {
							Rollover();
							gg = 1
						}
						if (page == 'ClearCheckboxes') {
							ClearCheckboxes();
							gg = 1
						}
						if (page == 'OpenEditor') {
							OpenEditor();
							gg = 1
						}
						if (page == 'UnhideCheckbox') {
							UnhideCheckbox();
							gg = 1
						}
						id = this.id
						if (id.slice(id.length - 8) == 'ShortCut') {
							position = button.className
							ShortCuts(id, page, position);
							gg = 1
						}
						if (page.slice(-5) == 'Files') {
							FilesPage(page);
							gg = 1
						}
						if (page == 'ReferenceHeader') {
							thisHeader = this
							ReferenceHeaderButton(thisHeader)
							gg = 1
						}
						if (page == 'search_posts') {
							showPage('Posts');
							historyPush('Posts');
							ClearPosts();
							Posts();
							gg = 1
						}
						if (page == 'Control') {
							if (localStorage.Control == 'On') {
								Control('Off');
							} else {
								Control('On');
							}
							gg = 1
						}
						if (page == 'change_password') {
							url = window.location.origin + '/' + user_id + '/change_password/';
							window.open(url, '_self');
						}
						if (page == 'messages') {
							const user_id = document.getElementById('user_id').innerHTML
							const this_user_id = button.name.replace('messageTo','')
							redirect(page, user_id, this_user_id)
							Messenger('On');
							gg = 1
						}
						if (page == 'CloseControl') {
							Control('Off');
							gg = 1
						}
						if (page == 'CloseMessenger') {
							Messenger('Off');
							gg = 1
						}
						if (page == 'friend_request') {
							id = button.name
							classB = button.className
							if (classB == 'btn btn-primary') {
								sendFriendRequest(id)
							}
							if (classB == 'btn btn-danger') {
								cancelFriendRequest(id)
							}
							toggleButton(id, classB)
							gg = 1
						}
						if (page == 'send_message') {
							messagesSend();
							gg = 1
						}
						if (page == 'New') {
							url = window.location.origin + '/' + user_id + '/WorkingPaper/MODEL';
							window.open(url, '_self');
						}
						if (page == 'Save') {
							Save()
							gg = 1
						}
						if (page == 'Logout') {
							url = window.location.origin + '/logout';
							window.open(url, '_self');
						}
						home = [
							'',
							'Home',
						]
						if (home.includes(page)) {
							page == 'Home'
						}
						if (page == 'Home') {
							try {
								a = document.getElementById('Authenticated')
								showPage(page)
								gg = 1
							} catch {
								url = window.location.origin + '/login/'
								window.open(url, '_self');
							}
						}
						if (page == 'Posts') {
							PostsUrl()
						}
						profile = [
							'profile',
						]
						if (profile.includes(page)) {
							redirect(page, user_id)
							gg = 1
						}
						if (gg < 1) {
							showPage(page);
							historyPush(page);
							Compile();
						}
					}
				}
			};
		</script>
		<!-- account -->
		<script>
			// account/account.js
			console.log('account/account.js')
			try {
				var cropper;
				var imageFile;
				var base64ImageString;
				var cropX;
				var cropX;
				var cropWidth;
				var cropHeight;
				enableImageOverlay()
			} catch {}
			function enableImageOverlay(){
				var text = document.getElementById("id_text")
				text.style.backgroundColor = "#0D47A1"
				text.style.color = "white"
				text.style.fontSize = "16px"
				text.style.padding = "16px 32px"
				text.style.cursor = "pointer"

				var profileImage = document.getElementById("id_profile_image_edit_profile")
				profileImage.style.opacity = "1"
				profileImage.style.display = "block"
				profileImage.style.width = "100%"
				profileImage.style.height = "auto"
				profileImage.style.transition = ".5s ease"
				profileImage.style.backfaceVisibility  = "hidden"
				profileImage.style.cursor = "pointer"

				var middleContainer = document.getElementById("id_middle_container")
				middleContainer.style.transition = ".5s ease"
				middleContainer.style.opacity = "0"
				middleContainer.style.position = "absolute"
				middleContainer.style.top = "50%"
				middleContainer.style.left = "50%"
				middleContainer.style.transform = "translate(-50%, -50%)"
				middleContainer.style.textAlign = "center"

				var imageContainer = document.getElementById("id_image_container")
				imageContainer.addEventListener("mouseover", function( event ) { 
					profileImage.style.opacity = "0.3"
					middleContainer.style.opacity = "1"
				})

				imageContainer.addEventListener("mouseout", function( event ) { 
					profileImage.style.opacity = "1"
					middleContainer.style.opacity = "0"
				})

				imageContainer.addEventListener("click", function(event){
					document.getElementById('id_profile_image_edit_profile').click();
				});

				var cropConfirm = document.getElementById("id_image_crop_confirm")
				cropConfirm.classList.remove("d-flex")
				cropConfirm.classList.remove("flex-row")
				cropConfirm.classList.remove("justify-content-between")
				cropConfirm.classList.add("d-none")
				
			}
			function disableImageOverlay(){
				var profileImage = document.getElementById("id_profile_image_edit_profile_display")
				var middleContainer = document.getElementById("id_middle_container")
				var imageContainer = document.getElementById("id_image_container")
				var text = document.getElementById("id_text")

				imageContainer.removeEventListener("mouseover", function( event ) { 
					profileImage.style.opacity = "0.3"
					middleContainer.style.opacity = "1"
				})

				imageContainer.removeEventListener("mouseout", function( event ) { 
					profileImage.style.opacity = "1"
					middleContainer.style.opacity = "0"
				})

				profileImage.style.opacity = "1"
				middleContainer.style.opacity = "0"
				text.style.cursor = "default"
				text.style.opacity = "0"

				document.getElementById('id_image_container').removeEventListener("click", function(event){
					event.preventDefault();
					// do nothing
				});
				document.getElementById('id_profile_image_edit_profile').addEventListener("click", function(event){
					event.preventDefault();
					// do nothing
				});

				var cropConfirm = document.getElementById("id_image_crop_confirm")
				cropConfirm.classList.remove("d-none")
				cropConfirm.classList.add("d-flex")
				cropConfirm.classList.add("flex-row")
				cropConfirm.classList.add("justify-content-between")

				var confirm = document.getElementById("id_confirm")
				confirm.addEventListener("click", function(event){
					//console.log("Sending crop data for processing...")
					cropImage(
						imageFile, 
						cropX, 
						cropY, 
						cropWidth,
						cropHeight
					)
					document.getElementById('edit').style.display = 'none';
					document.getElementById('CloseMessenger').click()
				})

				var cancel = document.getElementById("id_cancel")
				cancel.addEventListener("click", function(event){
					console.log("Reloading window...")
					window.location.reload();
				})
			}
			function isImageSizeValid(image){
				console.log("max size: {{DATA_UPLOAD_MAX_MEMORY_SIZE}}")
				var startIndex = image.indexOf("base64,") + 7;
				var base64str = image.substr(startIndex);
				var decoded = atob(base64str);
				console.log("FileSize: " + decoded.length);
				if(decoded.length>= "{{DATA_UPLOAD_MAX_MEMORY_SIZE}}"){
					return null
				}
				return base64str
			}
			function cropImage(image, x, y, width, height){
				base64ImageString = isImageSizeValid(image)
				if(base64ImageString != null){
					var requestData = {
						"csrfmiddlewaretoken": "{{ csrf_token }}",
						"image": base64ImageString,
						"cropX": cropX,
						"cropY": cropY,
						"cropWidth": cropWidth,
						"cropHeight": cropHeight
					}
					displayLoadingSpinner(true)
					$.ajax({
						type: 'POST',
						dataType: "json",
						url: "{% url 'crop_image' user_id=form.initial.id %}",
						data: requestData,
						timeout: 10000,
						success: function(data) {
							if(data.result == "success"){
								document.getElementById("id_cancel").click()
								// window.location.reload()
							}
							else if(data.result == "error"){
								alert(data.exception)
								document.getElementById("id_cancel").click()
							}
						},
						error: function(data) {
							console.error("ERROR...", data)
						},
						complete: function(data){
							displayLoadingSpinner(false)
						}
					});
				}
				else{
					alert("Upload an image smaller than 10 MB");
					document.getElementById("id_cancel").click()
				}
			}
			function readURL(input) {
				if (input.files && input.files[0]) {
					var reader = new FileReader();

					reader.onload = function (e) {
						disableImageOverlay()
						var image = e.target.result
						var imageField = document.getElementById('id_profile_image_edit_profile_display')
						imageField.src = image
						cropper = new Cropper(imageField, {
							aspectRatio: 1/1,
							crop(event) {
								//console.log("CROP START")
								//console.log("x: " + event.detail.x);
								//console.log("y: " + event.detail.y);
								//console.log("width: " + event.detail.width);
								//console.log("height: " + event.detail.height);
								setImageCropProperties(
									image,
									event.detail.x,
									event.detail.y,
									event.detail.width,
									event.detail.height
								)
							},
						});
					};
					reader.readAsDataURL(input.files[0]);
				}
			};
			function setImageCropProperties(image, x, y, width, height){
				imageFile = image
				cropX = x
				cropY = y
				cropWidth = width
				cropHeight = height
			}
		</script>		
		<!-- base -->
		<script src="{% static 'js/base/base.js' %}"></script>
		<script src="{% static 'js/base/date.js' %}"></script>
		<script src="{% static 'js/base/header.js' %}"></script>
		<script src="{% static 'js/base/resize.js' %}"></script>
		<!-- controlPanel -->
		<script src="{% static 'js/controlPanel/controlPanel.js' %}"></script>
		<!-- friend -->
		<script src="{% static 'js/friend/friend.js' %}"></script>
		<!-- messenger -->
		<script src="{% static 'js/messenger/messenger.js' %}"></script>
		<!-- messenger notifications -->
		<script src="{% static 'js/messengerNotification/messengerNotification.js' %}"></script>
		<!-- network -->
		<script src="{% static 'js/network/network.js' %}"></script>
		<!-- notification -->
		<script src="{% static 'js/notification/notification.js' %}"></script>
		<!-- posts -->
		<script src="{% static 'js/posts/posts.js' %}"></script>
		<!-- workingPaper -->
		<!-- analysis -->
		<script src="{% static 'js/workingPaper/analysis/audit.js' %}"></script>
		<script src="{% static 'js/workingPaper/analysis/compile.js' %}"></script>
		<script src="{% static 'js/workingPaper/analysis/context.js' %}"></script>
		<script src="{% static 'js/workingPaper/analysis/financials.js' %}"></script>
		<script src="{% static 'js/workingPaper/analysis/valuation.js' %}"></script>
		<!-- base -->
		<script src="{% static 'js/workingPaper/base/base.js' %}"></script>
		<script src="{% static 'js/workingPaper/base/checkboxes.js' %}"></script>
		<script src="{% static 'js/workingPaper/base/enter.js' %}"></script>
		<script src="{% static 'js/workingPaper/base/openEditor.js' %}"></script>
		<script src="{% static 'js/workingPaper/base/ref.js' %}"></script>
		<script src="{% static 'js/workingPaper/base/shortcuts.js' %}"></script>
		<script src="{% static 'js/workingPaper/base/tabulation.js' %}"></script>
		<script src="{% static 'js/workingPaper/base/unhideRows.js' %}"></script>
		<!-- files -->
		<script src="{% static 'js/workingPaper/files/enter.js' %}"></script>
		<script src="{% static 'js/workingPaper/files/files.js' %}"></script>
		<script src="{% static 'js/workingPaper/files/open.js' %}"></script>
		<script src="{% static 'js/workingPaper/files/print.js' %}"></script>
		<script src="{% static 'js/workingPaper/files/rollover.js' %}"></script>
		<script src="{% static 'js/workingPaper/files/save.js' %}"></script>
		<!-- graph -->
		<script src="{% static 'js/workingPaper/graph/linechart.js' %}"></script>
		<script src="{% static 'js/workingPaper/graph/puck.js' %}"></script>
		<!-- dom -->
		<script src="{% static 'js/dom/dom.js' %}"></script>
	</body>
</html>