
{% load static %}

<!-- html -->
<!DOCTYPE html>
<html lang=en>

	<!-- head -->
	<head>

		<!-- Required meta tags -->
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		<link rel="stylesheet" href="{% static 'bootstrap/css/bootstrap.min.css' %}">
		<link href="https://fonts.googleapis.com/css2?family=Material+Icons" rel="stylesheet">

		<!-- favicon -->
		<link rel="shortcut icon" href="{% static 'clockdb/favicon.ico' %}">
		<link rel="icon" href="{% static 'clockdb/favicon.ico' %}" type="image/x-icon">

		<!-- Cropperjs -->
		<!--
		<link rel="stylesheet" href="{% static 'cropperjs/dist/cropper.min.css' %}">
		 -->

		<!-- Markdown-it -->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/markdown-it/11.0.1/markdown-it.min.js"
			integrity="sha512-hW0KbtvDnXCHbh2UCNP/6R+oXxCKiOfm9ciuUekdGBCQF1+57bGqZAk3sAFir7PMQstyRW0UecsSc2HQotH2vg=="
			crossorigin="anonymous"></script>
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/styles/default.min.css"
			integrity="sha512-kZqGbhf9JTB4bVJ0G8HCkqmaPcRgo88F0dneK30yku5Y/dep7CZfCnNml2Je/sY4lBoqoksXz4PtVXS4GHSUzQ=="
			crossorigin="anonymous" />
		<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/highlight.min.js"
			integrity="sha512-TDKKr+IvoqZnPzc3l35hdjpHD0m+b2EC2SrLEgKDRWpxf2rFCxemkgvJ5kfU48ip+Y+m2XVKyOCD85ybtlZDmw=="
			crossorigin="anonymous"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/languages/kotlin.min.js"
			integrity="sha512-8aYTnyDstX39PHxorDD+6ROknf98Vqr5KTOjwRCl/442uAVKOpCJ5wY9I3VQ6y46rdDJKYBIglIfE2+GQk8U5Q=="
			crossorigin="anonymous"></script>
		<script> hljs.initHighlightingOnLoad(); </script>

	</head>

	<body>

		<!-- header -->
		<div class="header" style="display: none">
			{% include 'base/base_css.html' %}
			{% include 'base/header.html' %}
		</div>

		<!-- user id -->
		<i id="user_id" style="display: none;">{{request.user.id}}</i>

		<!-- panel -->
		<div class="Panel">
			<div class="panelHeader">
				{% include 'base/panelHeader.html' %}
			</div>
			<div class="Control">
				{% include 'panel/control.html' %}
			</div>
			<div class="Messenger">
				{% include 'panel/messenger.html' %}
			</div>
			<div class="MessengerNotifications">
				{% include 'panel/messengerNotifications.html' %}
			</div>
			<div class="Notifications">
				{% include 'panel/notifications.html' %}
			</div>	
		</div>

		<!-- main -->
		<div class="main">

			<!-- block content -->
			<div class="content">
				{% block content %}
				{% endblock content %}

				<!-- loading -->
				<div class="loading">
					<div id="id_loading_spinner">
						<span class="d-flex flex-row mx-auto flex-grow-1 justify-content-center">
							<span class="spinner-border text-primary" role="status">
								<span class="sr-only">Loading...</span>
							</span>
						</span>
					</div>
				</div>
			</div>

			<!-- footer -->
			{% include 'base/footer.html' %}

		</div>

		<!-- collections -->
		<script src="{% static 'collections/collections.min.js' %}"></script>

		<!-- jquery -->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.js"
			integrity="sha512-WNLxfP/8cVYL9sj8Jnp6et0BkubLP31jhTG9vhL/F5uEZmg5wEzKoXp1kJslzPQWwPT1eyMiSxlKCgzHLOTOTQ=="
			crossorigin="anonymous"></script>

		<!-- ajax chart -->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.1.3/Chart.min.js"></script>

		<!-- papaparse -->
		<script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.1/papaparse.min.js"></script>

		<!-- bootstrap -->
		<script src="{% static 'bootstrap/js/bootstrap.bundle.min.js' %}"></script>

		<!--
		<script type="module" src="{% static 'cropperjs/dist/cropper.min.js' %}"></script>
		-->

		<!-- js/onePageApp.js -->
		<script>

			console.log('js/onePageApp.js')
			
			// on load
			function onePageAppOnLoad(hideIf) {
				const user_id = document.getElementById('user_id').innerHTML
				var page = window.location.pathname.replace('/','').split('/')[1];
				if (user_id != '') {
					document.querySelectorAll('div').forEach(div => {
						hideDiv(div);
					});
					document.querySelectorAll('button').forEach(button => {
						onePageApp(button);
					})
					// φ
					if (page == 'WorkingPaper') {
						var subpage = window.location.href.replace(window.location.origin,'').split('/')[4]
						if (subpage == '') {
							subpage = 'Opinion'
						}
						showPage(subpage)
						Compile();
						ts = document.getElementById('TradingSymbol1').value;
						document.title = 'Clockdb | ' + ts + ' | '+ subpage;
						page = subpage
						history.pushState({page}, ``, `/${user_id}/WorkingPaper/${ts}/${page}/`);
					// Posts
					} else {
						// phase
						if (page == 'phase') {
							url = window.location.origin + '/'
							window.open(url, '_self');
						}
						// home
						home = [
							undefined,
							'',
							'home',
							'Home',
						]
						if (home.includes(page)) {
							try {
								a = document.getElementById('user_id').innerHTML
								if (a != 'None') {
									activeurl = window.location.href.replace(window.location.origin,'').replaceAll('/','')
									activeurlsub = window.location.href.split('/')[1]
									url = window.location.origin + '/' + a + '/Posts/'
									if (activeurl != a) {
										window.open(url, '_self');
									} else {
										page = 'Posts'
										document.title = 'Clockdb | ' + page;
										history.pushState({page}, ``, `/${user_id}/${page}/`);
										showPage(page)
									}
								}
							} catch {
								url = window.location.origin + '/login'
								window.open(url, '_self');
							}
						// others
						} else {
							document.title = 'Clockdb | ' + page;
							history.pushState({page}, ``, ``);
							showPage(page)
						}
					}
				}
			};
			
			// buttons
			function onePageApp(button) {
				button.onclick = function() {
					user_id = document.getElementById('user_id').innerHTML;
					page = this.dataset.page;
					gg = 0
					if (page != "#") {
						if (page == 'Messenger') {
							if (localStorage.Messenger == 'On') {
								Messenger('Off');
							} else {
								Messenger('On')
							}
							gg = 1
						}
						if (page == 'MessengerNotifications') {
							if (localStorage.MessengerNotifications == 'On') {
								MessengerNotifications('Off');
							} else {
								MessengerNotifications('On');
							}
							gg = 1
						}
						if (page == 'Notifications') {
							if (localStorage.Notifications == 'On') {
								Notifications('Off')
							} else {
								Notifications('On')
							}
							setGeneralNotificationsAsRead();
							gg = 1
						}
						if (page == 'SortAndOrder') {
							SortAndOrder(button.id);
							gg = 1
						}
						if (page == 'Print') {
							Print();
							gg = 1
						}
						if (page == 'UploadConfirm') {
							UploadConfirm();
							gg = 1
						}
						if (page == 'Save') {
							Save();
							gg = 1
						}
						if (page == 'Rollover') {
							Rollover();
							gg = 1
						}
						if (page == 'ClearCheckboxes') {
							ClearCheckboxes();
							gg = 1
						}
						if (page == 'OpenEditor') {
							OpenEditor();
							gg = 1
						}
						if (page == 'UnhideCheckbox') {
							UnhideCheckbox();
							gg = 1
						}
						id = this.id
						if (id.slice(id.length - 8) == 'ShortCut') {
							position = button.className
							ShortCuts(id, page, position);
							gg = 1
						}
						if (page.slice(-5) == 'Files') {
							FilesPage(page);
							gg = 1
						}
						if (page == 'ReferenceHeader') {
							thisHeader = this
							ReferenceHeaderButton(thisHeader)
							gg = 1
						}
						if (page == 'search_posts') {
							showPage('Posts');
							historyPush('Posts');
							ClearPosts();
							Posts();
							gg = 1
						}
						if (page == 'Control') {
							if (localStorage.Control == 'On') {
								Control('Off');
							} else {
								Control('On');
							}
							gg = 1
						}
						if (page == 'change_password') {
							url = window.location.origin + '/' + user_id + '/change_password/';
							window.open(url, '_self');
						}
						if (page == 'messages') {
							const user_id = document.getElementById('user_id').innerHTML
							const this_user_id = button.name.replace('messageTo','')
							redirect(page, user_id, this_user_id)
							Messenger('On');
							gg = 1
						}
						if (page == 'CloseControl') {
							Control('Off');
							gg = 1
						}
						if (page == 'CloseMessenger') {
							Messenger('Off');
							gg = 1
						}
						if (page == 'friend_request') {
							id = button.name
							classB = button.className
							if (classB == 'btn btn-primary') {
								sendFriendRequest(id)
							}
							if (classB == 'btn btn-danger') {
								cancelFriendRequest(id)
							}
							toggleButton(id, classB)
							gg = 1
						}
						if (page == 'send_message') {
							messagesSend();
							gg = 1
						}
						if (page == 'New') {
							url = window.location.origin + '/' + user_id + '/WorkingPaper/MODEL';
							window.open(url, '_self');
						}
						if (page == 'Save') {
							Save()
							gg = 1
						}
						if (page == 'Logout') {
							url = window.location.origin + '/logout';
							window.open(url, '_self');
						}
						home = [
							'',
							'Home',
						]
						if (home.includes(page)) {
							page == 'Home'
						}
						if (page == 'Home') {
							try {
								a = document.getElementById('Authenticated')
								showPage(page)
								gg = 1
							} catch {
								url = window.location.origin + '/login/'
								window.open(url, '_self');
							}
						}
						if (page == 'Posts') {
							PostsUrl()
						}
						profile = [
							'profile',
						]
						if (profile.includes(page)) {
							redirect(page, user_id)
							gg = 1
						}
						if (gg < 1) {
							showPage(page);
							historyPush(page);
							Compile();
						}
					}
				}
			};

		</script>

		<!-- js/account/account.js -->
		<script src="{% static 'js/account/account.js' %}"></script>

		<!-- base/base.js -->
		<script>

			console.log('base/base.js')
			
			// redirect
			function redirect(page, user_id, this_user_id) {
				z = 0
				b = window.location.href.replace(window.location.origin,'')
				a = b.split('/')[1]
				b = b.split('/')[2]
				if (a == user_id) {
					if (page == 'profile') {
						z = 1
					}
				} else {
					if (a == user_id) {
						z = 1
					}
				}
				if (page == 'messages') {
					onSelectFriend(this_user_id)
					Messenger('On')
				} else {
					if (z == 1) {
						showPage(page)
						historyPush(page)
					} else {
						url = window.location.origin + '/' + user_id + '/' + page;
						window.open(url, '_self');
						showPage(page)
						historyPush(page)
					}
				}
			}
			
			// history push
			function historyPush(page) {
				user_id = window.location.href.replace(window.location.origin,'');
				user_id = user_id.split('/')[1];
				a = 1
				try {
					ts = document.getElementById('TradingSymbol1').value
					w = window.location.href
					o = window.location.origin
					w = w.replace(o, '')
					o = w.split('/')[2]
				} catch {}
				try {
					if (o == 'WorkingPaper') {
						history.pushState({page}, ``, `/${user_id}/WorkingPaper/${ts}/${page}/`);
						document.title = 'Clockdb | ' + ts + ' | ' + page;
						a = 0
					}
					else {}
				} catch {}
				if (a == 1) {
					history.pushState({page}, ``, `/${user_id}/${page}/`);
					document.title = 'Clockdb | ' + page;
				}
			}
			
			// popstate

			function positionpopstate() {
				try {
					a = document.getElementById(localStorage.position)
					a.focus()
					a.select()
				} catch {}
			}

			window.onpopstate = function(event) {
				showPage(event.state.page);
				positionpopstate();
			}

			function historyBack() {
				window.history.back();
				positionpopstate();
			}

			function historyForward() {
				window.history.forward();
				positionpopstate();		
			}
			
			// showPage
			function showPage(page) {
				const loading = document.getElementById('id_loading_spinner')
				const searchBar = document.getElementById('SearchBar')
				const searchUsersBar = document.getElementById('SearchUsersBar')
				loading.style.display = 'block';
				searchBar.value = '';
				searchUsersBar.value = '';
				document.querySelectorAll('div').forEach(div => {
					hideDiv(div)
				})
				try {
					document.getElementById(page).style.display = 'block';
					window.scrollTo(0, 0)
				} catch {}
				loading.style.display = 'none';
			}
			
			// hide div
			function hideDiv(div) {
				skip = [
					// loading
					'id_loading_spinner',
					// header
					'id_chat_notification_dropdown_toggle',
					'id_chat_notifications_container',
					'id_notification_dropdown_toggle',
					'id_general_notifications_container',
					// room
					'id_chatroom_card',
					'id_room_title',
					'id_chat_log_container',
					'id_chatroom_loading_spinner_container',
					'id_chatroom_loading_spinner',
					'id_client_error_modal',
				]
				if (skip.includes(div.id)) {
				} else {
					z = 0
					try {
						a = parseInt(div.id.replace('m',''))
						if (isNaN(a)) {
							z = 1
						}
					} catch {
						z = 1
					}
					if (z == 1) {
						if (div.id != '') {
							div.style.display = 'none';
						}
					}
				}
			}
			
			// display

			function display(hideIf) {
				const user_id = document.getElementById('user_id').innerHTML
				const loading = document.getElementById('id_loading_spinner')
				loading.style.display = 'block';
				var page = window.location.pathname
				page = page.split('/')[2];
				document.getElementById('clockdbSpan').style.display = 'inline-block';
				document.getElementById('HomeSpan').style.display = 'inline-block';
				try {
					if (page != 'password_change') {
						document.getElementById('NotAuthenticated').style.display = 'inline-block';
					}
				} catch {
					document.getElementById('Authenticated').style.display = 'inline-block';
				}
				if (hideIf.includes(page)) {
				} else {
					if (page == 'WorkingPaper') {
						a = 'inline-block';
						b = 'none';
						c = 'inline-block';
					} else {
						a = 'none';
						b = 'inline-block';
						c = 'inline-block';
					}
					document.getElementById('FilesSpan').style.display = a;
					document.getElementById('GearSpan').style.display = a;
					document.getElementById('FinancialsSpan').style.display = a;
					document.getElementById('AuditSpan').style.display = a;
					document.getElementById('ValuationSpan').style.display = a;
					document.getElementById('OpinionSpan').style.display = a;
					document.getElementById('MoreSpan').style.display = a;
					//
					document.getElementById('PostsSpan').style.display = b;
					//document.getElementById('DatabaseSpan').style.display = b;
					//
					//document.getElementById('ControlSpan').style.display = c;
					//document.getElementById('MessengerNotificationsSpan').style.display = c;
					//document.getElementById('NotificationsSpan').style.display = c;
					document.getElementById('SearchBarSpan').style.display = c;
					document.getElementById('SearchUsersBarSpan').style.display = c;
					try {
						if (user_id != "{{id}}") {
							username = "{{username}}"
							username = username.toLowerCase()
							a = username + ' network'
						} else {
							a = 'My Network'
						}
						document.getElementById('SearchUsersBar').placeholder = a
						if (window.innerWidth > 799) {
							a = '80%';
						} else {
							a = '60%';
						}
						document.getElementsByClassName('clockdb')[0].style.width = a;
						document.getElementsByClassName('loading')[0].style.width = a;
					} catch {}
				}
				document.getElementById('HeaderMenu').style.display = 'block';
				document.getElementsByClassName('header')[0].style.display = 'block';
				document.getElementsByClassName('panelHeader')[0].style.display = 'block';
				loading.style.display = 'none';
			}

			function preloadCallback(src, elementId){
				var img = document.getElementById(elementId)
				img.src = src
			}

			function preloadImage(imgSrc, elementId){
				// console.log("attempting to load " + imgSrc + " on element " + elementId)
				var objImagePreloader = new Image();
				objImagePreloader.src = imgSrc;
				if(objImagePreloader.complete){
					preloadCallback(objImagePreloader.src, elementId);
					objImagePreloader.onload = function(){};
				}
				else{
					objImagePreloader.onload = function() {
						preloadCallback(objImagePreloader.src, elementId);
						//    clear onLoad, IE behaves irratically with animated gifs otherwise
						objImagePreloader.onload=function(){};
					}
				}
			}

			function validateText(str)
			{
				var md = window.markdownit({
					highlight: function (str, lang) {
						if (lang && hljs.getLanguage(lang)) {
							try {
								return '<pre class="hljs"><code>' +
									hljs.highlight(lang, str, true).value +
									'</code></pre>';
							} catch (__) {}
						}
						return '<pre class="hljs"><code>' + md.utils.escapeHtml(str) + '</code></pre>';
					},
					linkify: true,
				});
				var result = md.render(str);
				return result
			}

			function displayLoadingSpinner(isDisplayed){
				var spinner = document.getElementById("id_loading_spinner")
				if(isDisplayed){
					spinner.style.display = "block"
				}
				else{
					spinner.style.display = "none"
				}
			}

		</script>

		<!-- base/header.js -->
		<script>

			console.log('base/header.js')
			
			var ws_scheme = window.location.protocol == "https:" ? "wss" : "ws";
			
			var ws_path = ws_scheme + '://' + window.location.host + ":8001";
			
			var notificationSocket = new WebSocket(ws_path);
			
			notificationSocket.onmessage = function(message) {
				var data = JSON.parse(message.data);
				//console.log(data)
				//console.log("Got general notification websocket message. " + data.general_msg_type);
				//console.log("Got chat notification websocket message. " + data.chat_msg_type);
				/*
					GENERAL NOTIFICATIONS
				*/
				// new 'general' notifications data payload
				if(data.general_msg_type == 0){
					handleGeneralNotificationsData(data['notifications'], data['new_page_number'])
				}
				// "General" Pagination exhausted. No more results.
				if(data.general_msg_type == 1){
					setGeneralPaginationExhausted()
				}
				// Refresh [newest_timestamp >= NOTIFICATIONS >= oldest_timestamp]
				if(data.general_msg_type == 2){
					refreshGeneralNotificationsData(data['notifications'])
				}
				if(data.general_msg_type == 3){
					handleNewGeneralNotificationsData(data['notifications'])
				}
				if(data.general_msg_type == 4){
					setUnreadGeneralNotificationsCount(data['count'])
				}
				if(data.general_msg_type == 5){
					updateGeneralNotificationDiv(data['notification'])
				}
				/*
					CHAT NOTIFICATIONS
				*/
				// new 'chat' notifications data payload
				if(data.chat_msg_type == 10){
					handleChatNotificationsData(data['notifications'], data['new_page_number'])
				}
				// "Chat" Pagination exhausted. No more results.
				if(data.chat_msg_type == 11){
					setChatPaginationExhausted()
				}
				// refreshed chat notifications
				if(data.chat_msg_type == 13){
					handleNewChatNotificationsData(data['notifications'])
				}
				if(data.chat_msg_type == 14){
					setChatNotificationsCount(data['count'])
				}
			}
			
			notificationSocket.onclose = function(e) {
				console.error('Notification Socket closed unexpectedly');
			};
			
			notificationSocket.onopen = function(e){
				//console.log("Notification Socket on open: " + e)
				setupGeneralNotificationsMenu()
				getFirstGeneralNotificationsPage()
				getUnreadGeneralNotificationsCount()
				setupChatNotificationsMenu()
				getFirstChatNotificationsPage()
			}
			
			notificationSocket.onerror = function(e){
				console.log('Notification Socket error', e)
			}
			
			if (notificationSocket.readyState == WebSocket.OPEN) {
				//console.log("Notification Socket OPEN complete.")
			} 
			else if (notificationSocket.readyState == WebSocket.CONNECTING){
				//console.log("Notification Socket connecting..")
			}

		</script>

		<!-- base/resize.js -->
		<script>

			console.log('base/resize.js')

			function resize(c, m, g, t) {
				a = ''
				if (c == 'none') {
					if (m == 'none') {
						if (g == 'none') {
							if (t == 'none') {
								a = '100%';
							}
						}
					} else {
						a = ''
					}
				} else {
					a = ''
				}
				if (a == '') {
					if (window.innerWidth > 799) {
						a = '80%';
					} else {
						a = '60%';
					}
				}
				document.getElementsByClassName('clockdb')[0].style.width = a;
				document.getElementsByClassName('loading')[0].style.width = a;
			}

			function innerWidthColumn() {
				var w = window.innerWidth;
				if (w < 799) {
					disp = 'none';
				} else {
					disp = '';
				}
				Columns(disp);
			}

			function Columns(disp) {
				a = document.getElementsByClassName('C2');
				for(let i = 0; i < a.length; i++) { 
					document.getElementsByClassName('C2')[i].style.display = disp;
				};
				a = document.getElementsByClassName('C3');
				for(let i = 0; i < a.length; i++) { 
					document.getElementsByClassName('C3')[i].style.display = disp;
				};
				a = document.getElementsByClassName('C4');
				for(let i = 0; i < a.length; i++) { 
					document.getElementsByClassName('C4')[i].style.display = disp;
				};
				a = document.getElementsByClassName('C5');
				for(let i = 0; i < a.length; i++) { 
					document.getElementsByClassName('C5')[i].style.display = disp;
				};
				a = document.getElementsByClassName('C6');
				for(let i = 0; i < a.length; i++) { 
					document.getElementsByClassName('C6')[i].style.display = disp;
				};
				document.getElementById('Clockφ2').style.display = disp;
				document.getElementById('Clockφ3').style.display = disp;
				document.getElementById('Clockφ4').style.display = disp;
				document.getElementById('Bridgeφ2').style.display = disp;
				document.getElementById('Bridgeφ3').style.display = disp;
				document.getElementById('Bridgeφ4').style.display = disp;
				localStorage.setItem('Column', 1)
			}

		</script>

		<!-- controlPanel/controlPanel.js -->
		<script>

			console.log('controlPanel/controlPanel.js')

			function hideIndustrySEC() {
				g = document.getElementsByName('Industry_SEC')
				for(let i = 0; i < g.length; i++) {
					g[i].style.display = 'none';
				}
			}

			function controlPanelTitles() {
				// marker
				marker = `
				<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-link-45deg" viewBox="0 0 16 16">
					<path d="M4.715 6.542 3.343 7.914a3 3 0 1 0 4.243 4.243l1.828-1.829A3 3 0 0 0 8.586 5.5L8 6.086a1.002 1.002 0 0 0-.154.199 2 2 0 0 1 .861 3.337L6.88 11.45a2 2 0 1 1-2.83-2.83l.793-.792a4.018 4.018 0 0 1-.128-1.287z"/>
					<path d="M6.586 4.672A3 3 0 0 0 7.414 9.5l.775-.776a2 2 0 0 1-.896-3.346L9.12 3.55a2 2 0 1 1 2.83 2.83l-.793.792c.112.42.155.855.128 1.287l1.372-1.372a3 3 0 1 0-4.243-4.243L6.586 4.672z"/>
				</svg>
				`
				// Sort
				try {
					a = document.getElementById('Sort')
					a = a.options[a.selectedIndex].text
					if (a == '') {
						a = 'Sort';
					} else {
						a = marker + 'Sort by ' + a;
					}
					c = document.getElementById('SortButton')
					c.innerHTML = a;
				} catch {}
				// Order
				try {
					a = document.getElementById('Order')
					a = a.options[a.selectedIndex].text
					if (a == '') {
						a = 'Order'
					} else {
						a = marker + a;
					}
					c = document.getElementById('OrderButton')
					c.innerHTML = a;
				} catch {}
				// Industry
				try {
					a = document.getElementById('Industry')
					a = a.options[a.selectedIndex].text
					if (a == '') {
						a = 'Industry'
					} else {
						a = marker + a;
					}
					c = document.getElementById('IndustryButton')
					c.innerHTML = a;
				} catch {}
				// Region
				try {
					a = document.getElementById('Region')
					a = a.options[a.selectedIndex].text
					if (a == '') {
						a = 'Region'
					} else {
						a = marker + a;
					}
					c = document.getElementById('RegionButton')
					c.innerHTML = a;
				} catch {}
				// Period
				try {
					a = document.getElementById('Period')
					a = a.options[a.selectedIndex].text
					if (a == '') {
						a = 'Year Ending'
					} else {
						a = marker + a;
					}
					c = document.getElementById('PeriodButton')
					c.innerHTML = a;
				} catch {}
				// Work In Progress
				try {		
					a = document.getElementById('WorkInProgress')
					a = a.options[a.selectedIndex].text
					if (a == 'Include Work In Progress') {
						a = 'Include Work In Progress'
					} else {
						a = marker + a;
					}
					c = document.getElementById('WorkInProgressButton')
					c.innerHTML = a;
				} catch {}
			}

			function IndustryChange() {
				try {
					controlPanelTitles();
					hideIndustrySEC();
					e = document.getElementById('Industry').value
					e = document.getElementById(e)
					e = e.parentElement
					e = e.parentElement
					e = e.parentElement
					e.style.display = 'block';
				} catch {}
			}

			function IndustrySECChange(e) {
				id = e.id.replace('m','')
				a = document.getElementById(id)
				for(let i = 0; i < a.length; i++) {
					if (a.options[i].value == a.value) {
						gg = a.options[i].innerHTML
					}
				}
				if (gg != '') {
					gg = `
						<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-link-45deg" viewBox="0 0 16 16">
							<path d="M4.715 6.542 3.343 7.914a3 3 0 1 0 4.243 4.243l1.828-1.829A3 3 0 0 0 8.586 5.5L8 6.086a1.002 1.002 0 0 0-.154.199 2 2 0 0 1 .861 3.337L6.88 11.45a2 2 0 1 1-2.83-2.83l.793-.792a4.018 4.018 0 0 1-.128-1.287z"/>
							<path d="M6.586 4.672A3 3 0 0 0 7.414 9.5l.775-.776a2 2 0 0 1-.896-3.346L9.12 3.55a2 2 0 1 1 2.83 2.83l-.793.792c.112.42.155.855.128 1.287l1.372-1.372a3 3 0 1 0-4.243-4.243L6.586 4.672z"/>
						</svg>
					` + gg
					id = 'IndustryButton_' + id
					document.getElementById(id).innerHTML = gg
				}
			}

			function OptionsSelection() {
				e = event.target
				a = document.getElementById(e.name)
				a.value = e.id.replace('Option', '')
				e.parentElement.style.display = 'none';
				controlPanelTitles();
				hideIndustrySEC();
				try {
					IndustryChange();
					IndustrySECChange(e);
				} catch {}
			}

			function OptionsSection(c) {
				f = c + 'OptionsSection'
				f = document.getElementsByClassName(f)[0]
				d = f.style.display
				if (d == 'none') {
					d = 'block';
				} else {
					d = 'none';
				}
				f.style.display = d;
				//
				a = document.getElementById(c).options
				//
				for(let i = 0; i < a.length; i++) {
					o = a[i].innerHTML
					if (o == '') {
						o = 'any'
					}
					option = `<button id="` + a[i].value + `Option` + `" class="` + `options` + `" name="` + c + `" onclick="OptionsSelection()">` + o + `</button>`
					optionsO = optionsO + option
				}
			}

			function SortAndOrderOptions(c) {
				optionsO = ''
				OptionsSection(c, optionsO)
				a = c + 'OptionsSection'
				a = document.getElementsByClassName(a)[0]
				a.innerHTML = optionsO
			}

			function SortAndOrder(id) {
				c = id.replace('Button','')
				if (c == 'Sort') {
					SortAndOrderOptions(c)
				}
				if (c == 'Order') {
					SortAndOrderOptions(c)
				}
				if (c == 'filterFor') {
					filterForRefresh();
				}
				if (c == 'Industry') {
					SortAndOrderOptions(c)
				}
				if (c == 'Region') {
					SortAndOrderOptions(c)
				}
				if (c == 'Period') {
					SortAndOrderOptions(c)
				}
				if (c == 'WorkInProgress') {
					WorkInProgressToggle()
				}
				c = id.slice(15)
				if (id.replace(c,'') == 'IndustryButton_') {
					SortAndOrderOptions(c)
				}
			}

			function filterForRefresh() {
				document.getElementById('Industry').value = 'any'
				document.getElementById('Region').value = 'any'
				document.getElementById('Period').value = 'any'
				controlPanelTitles();
				hideIndustrySEC();
			}

			function WorkInProgressToggle() {
				a = document.getElementById('WorkInProgress').value
				if (a == '21') {
					a = 'any';
				} else {
					a = '21';
				}
				document.getElementById('WorkInProgress').value = a;
				controlPanelTitles();
			}

			function controlPanel() {
				try {
					a = window.location.href.replace(window.location.origin,'').split('/')[2]
					if (a == 'WorkingPaper') {
						a = 'Working Paper'
						wp = 'block'
						p = 'none'
					} else {
						a = 'Posts'
						wp = 'none'
						p = 'block'
					}
					document.getElementsByClassName('controlWorkingPaper')[0].style.display = wp;
					document.getElementsByClassName('controlPosts')[0].style.display = p;
					document.getElementsByClassName('controlHeaderTitle')[0].innerHTML = a;
				} catch {}
			};

			function closePanel() {
				c = 'none'
				m = 'none'
				g = 'none'
				t = 'none'
				document.getElementsByClassName('Control')[0].style.display = c;
				document.getElementsByClassName('Messenger')[0].style.display = m;
				document.getElementsByClassName('MessengerNotifications')[0].style.display = g;
				document.getElementsByClassName('Notifications')[0].style.display = t;
				document.getElementsByClassName('clockdb')[0].style.width = '100%';
				document.getElementsByClassName('loading')[0].style.width = '100%';
				localStorage.setItem('Control', 'Off')
				localStorage.setItem('Messenger', 'Off')
				localStorage.setItem('MessengerNotifications', 'Off')
				localStorage.setItem('Notifications', 'Off')
			}

			function toggleButton(id, classB) {
				if (classB == 'btn btn-danger') {
					classA = 'btn btn-primary'
					innerHTML = 'Send Friend Request'
				} else {
					classA = 'btn btn-danger'
					innerHTML = 'Cancel Friend Request'
				}
				a = document.getElementsByName(id)[0].className = classA
				a = document.getElementsByName(id)[0].innerHTML = innerHTML
				b = document.getElementsByName(id)[1].className = classA
				a = document.getElementsByName(id)[1].innerHTML = innerHTML
			}

			function Notifications(Arg) {
				if (Arg == 'On') {
					c = 'none'
					m = 'none'
					g = 'none'
					t = 'block'
					Panel(c, m, g, t, 'Notifications')
				} else {
					closePanel()
				}
			}

			function MessengerNotifications(Arg) {
				if (Arg == 'On') {
					c = 'none'
					m = 'none'
					g = 'block'
					t = 'none'
					Panel(c, m, g, t, 'MessengerNotifications')
				} else {
					closePanel()
				}
			}

			function Messenger(Arg) {
				if (Arg == 'On') {
					c = 'none'
					m = 'block'
					g = 'none'
					t = 'none'
					Panel(c, m, g, t, 'Messenger')
				} else {
					closePanel()
				}
				messageInputFocus();
			}

			function Control(Arg) {
				if (Arg == 'On') {
					c = 'block'
					m = 'none'
					g = 'none'
					t = 'none'
					Panel(c, m, g, t, 'Control')
				} else {
					closePanel()
				}
			}

			function Panel(c, m, g, t, r) {
				z = 'border-bottom: solid #0D47A1;'
				s = 'border-bottom: solid white;'
				document.getElementsByClassName('Control')[0].style.display = c;
				document.getElementsByClassName('Messenger')[0].style.display = m;
				document.getElementsByClassName('MessengerNotifications')[0].style.display = g;
				document.getElementsByClassName('Notifications')[0].style.display = t;
				resize(c, m, g, t)
				document.getElementById('ControlButton').style = s
				document.getElementById('MessengerButton').style = s
				document.getElementById('MessengerNotificationsButton').style = s
				document.getElementById('NotificationsButton').style = s
				document.getElementById(r + 'Button').style = z
				localStorage.setItem('Control', 'Off')
				localStorage.setItem('Messenger', 'Off')
				localStorage.setItem('MessengerNotifications', 'Off')
				localStorage.setItem('Notifications', 'Off')
				localStorage.setItem(r, 'On')
			}


		</script>

		<!-- js/friend/friend.js -->
		<script>
			
			console.log('friend/friend.js')

			function onFriendRequestAccepted(){
				location.reload();
			}

			function onFriendRequestDeclined(){
				location.reload();
			}

			function triggerAcceptFriendRequest(friend_request_id){
				acceptFriendRequest(friend_request_id, onFriendRequestAccepted)
			}

			function triggerDeclineFriendRequest(friend_request_id){
				declineFriendRequest(friend_request_id, onFriendRequestDeclined)
			}

			function onFriendRemoved(){
				location.reload();
			}

			function onFriendRequestAccepted(){
				location.reload();
			}

			function onFriendRequestDeclined(){
				location.reload();
			}

			function sendFriendRequest(id){
				payload = {
					"csrfmiddlewaretoken": "{{ csrf_token }}",
					"receiver_user_id": id,
				}
				$.ajax({
					type: 'POST',
					dataType: "json",
					url: "{% url 'friend-request' %}",
					timeout: 5000,
					data: payload,
					success: function(data) {
						//console.log("SUCCESS", data)
						if(data['response'] == "Friend request sent."){
							// ui is updated
						}
						else if(data['response'] != null){
							alert(data['response'])
						}
					},
					error: function(data) {
						console.error("ERROR...", data)
						alert("Something went wrong.")
					},
					complete: function(data){}
				});
			}

			function cancelFriendRequest(id){
				payload = {
					"csrfmiddlewaretoken": "{{ csrf_token }}",
					"receiver_user_id": id,
				}
				$.ajax({
					type: 'POST',
					dataType: "json",
					url: "{% url 'friend-request-cancel' %}",
					data: payload,
					timeout: 5000,
					success: function(data) {
						//console.log("SUCCESS", data)
						if(data['response'] == "Friend request canceled."){
							// ui is updated
						}
						else if(data['response'] != null){
							alert(data['response'])
						}
					},
					error: function(data) {
						console.error("ERROR...", data)
						alert("Something went wrong.")
					},
					complete: function(data){}
				});
			}

			try {
				var removeFriendBtn = document.getElementById("id_unfriend_btn")
				if (removeFriendBtn != null){
					removeFriendBtn.addEventListener("click", function(){
						removeFriend("{{id}}", onFriendRemoved)
					})
				}
			} catch {}

			function removeFriend(id, uiUpdateFunction){
				payload = {
					"csrfmiddlewaretoken": "{{ csrf_token }}",
					"receiver_user_id": id,
				}
				$.ajax({
					type: 'POST',
					dataType: "json",
					timeout: 5000,
					url: "{% url 'remove-friend' %}",
					data: payload,
					success: function(data) {
						//console.log("SUCCESS", data)
						if(data.response == "Successfully removed that friend."){
							// UI gets updated
						}
						else if(data.response != null){
							alert(data.response)
						}
					},
					error: function(data) {
						console.error("ERROR...", data)
						alert("Something went wrong." + data)
					},
					complete: function(data){
						uiUpdateFunction()
					}
				});
			}

			function triggerAcceptFriendRequest(friend_request_id){
				acceptFriendRequest(friend_request_id, onFriendRequestAccepted)
			}

			function acceptFriendRequest(friend_request_id, uiUpdateFunction){
				var url = "{% url 'friend-request-accept' friend_request_id=53252623623632623 %}".replace("53252623623632623", friend_request_id)
				$.ajax({
					type: 'GET',
					dataType: "json",
					url: url,
					timeout: 5000,
					success: function(data) {
						//console.log("SUCCESS", data)
						if(data['response'] == "Friend request accepted."){
							// ui is updated
						}
						else if(data['response'] != null){
							alert(data['response'])
						}
					},
					error: function(data) {
						console.error("ERROR...", data)
						alert("Something went wrong: " + data)
					},
					complete: function(data){
						uiUpdateFunction()
					}
				});
			}

			function triggerDeclineFriendRequest(friend_request_id){
				declineFriendRequest(friend_request_id, onFriendRequestDeclined)
			}

			function declineFriendRequest(friend_request_id, uiUpdateFunction){
				var url = "{% url 'friend-request-decline' friend_request_id=53252623623632623 %}".replace("53252623623632623", friend_request_id)
				$.ajax({
					type: 'GET',
					dataType: "json",
					url: url,
					timeout: 5000,
					success: function(data) {
						//console.log("SUCCESS", data)
						if(data['response'] == "Friend request declined."){
							// ui is updated
						}
						else if(data['response'] != null){
							alert(data['response'])
						}
					},
					error: function(data) {
						console.error("ERROR...", data)
						alert("Something went wrong: " + data)
					},
					complete: function(data){
						uiUpdateFunction()
					}
				});
			}
				
			function friendRequestButtonsOnStart() {
				FR = "{{ friends_requests }}"
				FR = FR.replace('[','')
				FR = FR.replace(']','')
				i = 0
				id = 0
				while (id != undefined) {
					try {
						id = FR.split(', ')[i]
						document.getElementsByName(id)[0].innerHTML = 'Cancel Friend Request';
						document.getElementsByName(id)[0].id = 'id_cancel_friend_request_btn_profiles';
						document.getElementsByName(id)[0].className = 'btn btn-danger';
						document.getElementsByName(id)[1].innerHTML = 'Cancel Friend Request';
						document.getElementsByName(id)[1].id = 'id_cancel_friend_request_btn_profiles';
						document.getElementsByName(id)[1].className = 'btn btn-danger';
					} catch {}
					i = i + 1
				}
			}

		</script>

		<!-- js/messenger/messenger.js -->
		<script>
			
			console.log('messenger/messenger.js')

			function messagesSend() {
				const messageInputDom = document.getElementById('id_chat_message_input');
				const message = messageInputDom.value;
				chatSocket.send(JSON.stringify({
					"command": "send",
					"message": message,
					"room": roomId
				}));
				messageInputDom.value = '';
			}

			function messageFrom(this_user_id) {
				const user_id = document.getElementById('user_id').innerHTML
				page = 'messages'
				redirect(page, user_id, this_user_id)
				Messenger('On');
			}

			function onSelectFriend(id){
				payload = {
					"csrfmiddlewaretoken": "{{ csrf_token }}",
					"user2_id": id,
				}
				$.ajax({
					type: 'POST',
					dataType: "json",
					url: "{% url 'create-or-return-private-chat' %}", // production
					data: payload,
					timeout: 5000,
					success: function(data) {
						//console.log("SUCCESS", data)
						if(data['response'] == "Successfully got the chat."){
							setupWebSocket(data['chatroom_id'])
						}
						else if(data['response'] != null){
							alert(data['response'])
						}
					},
					error: function(data) {
						console.error("ERROR...", data)
						alert("Something went wrong.")
					},
				});
				clearHighlightedFriend();
				highlightFriend(id);
				Messenger('On');
			}

			function closeWebSocket(){
				if(chatSocket != null){
					chatSocket.close()
					chatSocket = null
					clearChatLog()
					setPageNumber("1")
					disableChatLogScrollListener()
				}
			}

			function setupWebSocket(room_id){

				//console.log("setupWebSocket: " + room_id)

				roomId = room_id

				// close previous socket if one is open
				closeWebSocket()

				// Correctly decide between ws:// and wss://
				var ws_scheme = window.location.protocol == "https:" ? "wss" : "ws";
				var ws_path = ws_scheme + '://' + window.location.host + ":8001/chat/" + roomId + "/"; // production
				
				// console.log("Connecting to " + ws_path);
				chatSocket = new WebSocket(ws_path);

				// Handle incoming messages
				chatSocket.onmessage = function(message) {
					// Decode the JSON
					// console.log("Got chat websocket message " + message.data);
					//console.log("Got websocket message.");
					var data = JSON.parse(message.data);

					// display the progress bar?
					displayChatroomLoadingSpinner(data.display_progress_bar)

					// Handle errors (ClientError)
					if (data.error) {
						console.error(data.error + ": " + data.message)
						showClientErrorModal(data.message)
						return;
					}
					// Handle joining (Client perspective)
					if (data.join) {
						//console.log("Joining room " + data.join);
						getUserInfo()
						getRoomChatMessages()
						enableChatLogScrollListener()
					}
					// Handle leaving (client perspective)
					if (data.leave) {
						// do nothing
						//console.log("Leaving room " + data.leave);
					}

					// user info coming in from backend
					if(data.user_info){
						handleUserInfoPayload(data.user_info)
					}

					// Handle getting a message
					if (data.msg_type == 0 || data.msg_type == 1 || data.msg_type == 2) {
						appendChatMessage(data, false, true)
					}

					// new payload of messages coming in from backend
					if(data.messages_payload){
						handleMessagesPayload(data.messages, data.new_page_number)
					}
				};

				chatSocket.addEventListener("open", function(e){
					//console.log("ChatSocket OPEN")
					// join chat room
					if("{{request.user.is_authenticated}}"){
						chatSocket.send(JSON.stringify({
							"command": "join",
							"room": roomId
						}));
					}
				})

				chatSocket.onclose = function(e) {
					//console.log('Chat socket closed.');
				};

				chatSocket.onOpen = function(e){
					//console.log("ChatSocket onOpen", e)
				}

				chatSocket.onerror = function(e){
					//console.log('ChatSocket error', e)
				}

				if (chatSocket.readyState == WebSocket.OPEN) {
					//console.log("ChatSocket OPEN")
				} else if (chatSocket.readyState == WebSocket.CONNECTING){
					//console.log("ChatSocket connecting..")
				}
			}

			function getUserInfo(){
				chatSocket.send(JSON.stringify({
					"command": "get_user_info",
					"room_id": roomId,
				}));
			}

			function handleUserInfoPayload(user_info){
				document.getElementById("id_other_username").innerHTML = user_info['username']
				document.getElementById("id_other_user_profile_image").classList.remove("d-none")
				document.getElementById("id_user_info_container").href= "/" + user_info['id'] + '/profile/'
				preloadImage(user_info['profile_image'], "id_other_user_profile_image")
			}

			function showClientErrorModal(message){
				document.getElementById("id_client_error_modal_body").innerHTML = message
				document.getElementById("id_trigger_client_error_modal").click()
			}

			function appendChatMessage(data, maintainPosition, isNewMessage){
				messageType = data['msg_type']
				msg_id = data['msg_id']
				message = data['message']
				uName = data['username']
				user_id = data['user_id']
				profile_image = data['profile_image']
				timestamp = data['natural_timestamp']
				//console.log("append chat message: " + messageType)
				
				var msg = "";
				var username = ""

				// determine what type of msg it is
				switch (messageType) {
					case 0:
						// new chatroom msg
						username = uName + ": "
						msg = message + '\n'
						createChatMessageElement(msg, msg_id, username, profile_image, user_id, timestamp, maintainPosition, isNewMessage)
						break;
					case 1:
						// User joined room
						createConnectedDisconnectedElement(message, msg_id, profile_image, user_id)
						break;
					case 2:
						// User left room
						createConnectedDisconnectedElement(message, msg_id, profile_image, user_id)
						break;
					default:
						console.log("Unsupported message type!");
						return;
				}
			}

			function createChatMessageElement(msg, msg_id, username, profile_image, user_id, timestamp, maintainPosition, isNewMessage){
				var chatLog = document.getElementById("id_chat_log")

				var newMessageDiv = document.createElement("div")
				newMessageDiv.classList.add("d-flex")
				newMessageDiv.classList.add("flex-row")
				newMessageDiv.classList.add("message-container")

				var profileImage = document.createElement("img")
				profileImage.addEventListener("click", function(e){
					selectUser(user_id)
				})
				profileImage.classList.add("profile-image-messages")
				profileImage.classList.add("rounded-circle")
				profileImage.classList.add("img-fluid")
				profileImage.src = "static/clockdb/dummy_image.png/"
				var profile_image_id = "id_profile_image_" + msg_id
				profileImage.id = profile_image_id
				newMessageDiv.appendChild(profileImage)

				var div1 = document.createElement("div")
				div1.classList.add("d-flex")
				div1.classList.add("flex-column")

				var div2 = document.createElement("div")
				div2.classList.add("d-flex")
				div2.classList.add("flex-row")

				var usernameSpan = document.createElement("span")
				usernameSpan.innerHTML = username
				usernameSpan.classList.add("username-span-messages")
				usernameSpan.addEventListener("click", function(e){
					selectUser(user_id)
				})
				div2.appendChild(usernameSpan)

				var timestampSpan = document.createElement("span")
				timestampSpan.innerHTML = timestamp
				timestampSpan.classList.add("timestamp-span")
				timestampSpan.classList.add("d-flex")
				timestampSpan.classList.add("align-items-center")
				timestampSpan.addEventListener("click", function(e){
					selectUser(user_id)
				})
				div2.appendChild(timestampSpan)

				div1.appendChild(div2)

				var msgP = document.createElement("p")
				msgP.innerHTML = validateText(msg)
				msgP.style="line-break: normal;"
				div1.appendChild(msgP)

				newMessageDiv.appendChild(div1)

				if(isNewMessage){
					chatLog.insertBefore(newMessageDiv, chatLog.firstChild)
				}
				else{
					chatLog.appendChild(newMessageDiv)
				}
				
				if(!maintainPosition){
					chatLog.scrollTop = chatLog.scrollHeight
				}

				preloadImage(profile_image, profile_image_id)
			}

			function createConnectedDisconnectedElement(msg, msd_id, profile_image, user_id){
				var chatLog = document.getElementById("id_chat_log")

				var newMessageDiv = document.createElement("div")
				newMessageDiv.classList.add("d-flex")
				newMessageDiv.classList.add("flex-row")
				newMessageDiv.classList.add("message-container")

				var profileImage = document.createElement("img")
				profileImage.addEventListener("click", function(e){
					selectUser(user_id)
				})
				profileImage.classList.add("profile-image-messages")
				profileImage.classList.add("rounded-circle")
				profileImage.classList.add("img-fluid")
				profileImage.src = "static/clockdb/dummy_image.png/"
				var profile_image_id = "id_profile_image_" + msg_id
				profileImage.id = profile_image_id
				newMessageDiv.appendChild(profileImage)

				var usernameSpan = document.createElement("span")
				usernameSpan.innerHTML = msg
				usernameSpan.classList.add("username-span-messages")
				usernameSpan.addEventListener("click", function(e){
					selectUser(user_id)
				})
				newMessageDiv.appendChild(usernameSpan)

				chatLog.insertBefore(newMessageDiv, chatLog.firstChild)

				preloadImage(profile_image, profile_image_id)
			}

			function setPageNumber(pageNumber){
				document.getElementById("id_page_number").innerHTML = pageNumber
			}

			function clearChatLog(){
				document.getElementById("id_chat_log").innerHTML = ""
			}

			function setPaginationExhausted(){
				setPageNumber("-1")
			}

			function getRoomChatMessages(){
				var pageNumber = document.getElementById("id_page_number").innerHTML
				if(pageNumber != "-1"){
					setPageNumber("-1") // loading in progress
					chatSocket.send(JSON.stringify({
						"command": "get_room_chat_messages",
						"room_id": roomId,
						"page_number": pageNumber,
					}));
				}
			}

			function handleMessagesPayload(messages, new_page_number){
				if(messages != null && messages != "undefined" && messages != "None"){
					setPageNumber(new_page_number)
					messages.forEach(function(message){
						appendChatMessage(message, true, false)
					})
				}
				else{
					setPaginationExhausted() // no more messages
				}
			}

			function selectUser(user_id){
				// Weird work-around for passing arg to url
				//var win = window.open(url, "_blank")
				//win.focus()
			}

			function chatLogScrollListener(e) {
				var chatLog = document.getElementById("id_chat_log")
				if ((Math.abs(chatLog.scrollTop) + 2) >= (chatLog.scrollHeight - chatLog.offsetHeight)) {
					getRoomChatMessages()
				}
			}

			function enableChatLogScrollListener(){
				document.getElementById("id_chat_log").addEventListener("scroll", chatLogScrollListener);
			}

			function disableChatLogScrollListener(){
				document.getElementById("id_chat_log").removeEventListener("scroll", chatLogScrollListener)
			}

			function displayChatroomLoadingSpinner(isDisplayed){
				//console.log("displayChatroomLoadingSpinner: " + isDisplayed)
				var spinner = document.getElementById("id_chatroom_loading_spinner")
				if(isDisplayed){
					spinner.style.display = "block"
				}
				else{
					spinner.style.display = "none"
				}
			}

			function highlightFriend(userId){
				// select new friend
				document.getElementById("id_friend_container_" + userId).style.background = "#f2f2f2"
			}

			function clearHighlightedFriend(){
			    {% if m_and_f %}
			        {% for x in m_and_f %}
			            document.getElementById("id_friend_container_{{x.friend.id}}").style.background = ""
			        {% endfor %}
			    {% endif %}
			    document.getElementById("id_other_user_profile_image").classList.add("d-none")
			    document.getElementById("id_other_user_profile_image").src = "/static/clockdb/dummy_image.png/"
			    document.getElementById("id_other_username").innerHTML = ""
			}

			function messageInputFocus() {
				a = document.getElementById('id_chat_message_input')
				a.focus()
			}

		</script>

		<!-- js/messengerNotification/messengerNotification.js -->
		<script>
			
			console.log('messengerNotification/messengerNotification.js')

			setOnChatNotificationScrollListener()
			onChatNotificationsPaginationTriggerListener()

			const CHAT_NOTIFICATION_INTERVAL = 4000
			var chatCachedNotifList = new List([])

			function submitNewChatNotificationToCache(notification){
				var result = chatCachedNotifList.filter(function(n){ 
					return n['notification_id'] === notification['notification_id']
				})
				// This notification does not already exist in the list
				if(result.length == 0){
					chatCachedNotifList.push(notification)

					// append to top of list
					appendTopChatNotification(notification)
				}
				// This notification already exists in the list
				else{
					// find the div and update it.
					refreshChatNotificationsList(notification)
				}
			}

			function submitChatNotificationToCache(notification){
				var result = chatCachedNotifList.filter(function(n){ 
					return n['notification_id'] === notification['notification_id']
				})
				// This notification does not already exist in the list
				if(result.length == 0){
					chatCachedNotifList.push(notification)

					// append to bottom of list
					appendBottomChatNotification(notification)
				}
				// This notification already exists in the list
				else{
					// find the div and update it.
					refreshChatNotificationsList(notification)
				}
			}

			function handleNewChatNotificationsData(notifications){
				if(notifications.length > 0){
					clearNoChatNotificationsCard()
					notifications.forEach(notification => {

						submitNewChatNotificationToCache(notification)

						setChatNewestTimestamp(notification['timestamp'])
					})
				}
			}

			function setChatNewestTimestamp(timestamp){
				element = document.getElementById("id_chat_newest_timestamp")
				current = element.innerHTML
				if(Date.parse(timestamp) > Date.parse(current)){
					element.innerHTML = timestamp
				}
				else if(current == "" || current == null || current == "undefined"){
					element.innerHTML = timestamp
				}
				//console.log("setChatNewestTimestamp: " + element.innerHTML)
			}

			function setupChatDropdownHeader(){
				var notificationContainer = document.getElementById("id_chat_notifications_container")

				if(notificationContainer != null){

					var div = document.createElement("div")
					div.classList.add("chat-dropdown-header", "d-flex", "flex-row", "justify-content-end", "m-auto", "align-items-end")

				}
			}

			function chatRedirect(url){
				window.location.href = url
			}

			function setupChatNotificationsMenu(){
				var notificationContainer = document.getElementById("id_chat_notifications_container")

				if(notificationContainer != null){
					setupChatDropdownHeader()

					card = createChatNotificationCard("id_no_chat_notifications")

					var div = document.createElement("div")
					div.classList.add("d-flex", "flex-row", "align-items-start")

					span = document.createElement("span")
					span.classList.add("align-items-start", "pt-1", "m-auto")
					span.innerHTML = "You have no notifications."
					div.appendChild(span)
					card.appendChild(div)
					notificationContainer.appendChild(card)

					setChatNotificationsCount([])
				}
			}

			function clearNoChatNotificationsCard(){
				var element = document.getElementById("id_no_chat_notifications")
				if(element != null && element != "undefined"){
					document.getElementById("id_chat_notifications_container").removeChild(element)
				}
			}

			function createChatNotificationCard(cardId){
				var card = document.createElement("div")
				if(cardId != "undefined"){
					card.id = cardId
				}
				card.classList.add("d-flex", "flex-column", "align-items-start", "chat-card","p-4")
				card.style = "width: 100%"
				return card
			}

			function createChatProfileImageThumbnail(notification){
				img = document.createElement("img")
				img.classList.add("notification-thumbnail-image", "img-fluid", "rounded-circle", "mr-2")
				img.src = notification['from']['image_url']
				img.id = assignChatImgId(notification['notification_id'])
				return img
			}

			function createChatTimestampElement(notification){
				var timestamp = document.createElement("p")
				timestamp.classList.add("small", "pt-2", "timestamp-text")
				timestamp.innerHTML = notification['natural_timestamp']
				timestamp.id = assignChatTimestampId(notification)
				return timestamp
			}

			function createUnreadChatRoomMessagesElement(notification){
				card = createChatNotificationCard()
				card.id = assignChatCardId(notification)
				card.addEventListener("click", function(){
					//chatRedirect(notification['actions']['redirect_url'])
					user_id = document.getElementById('user_id').innerHTML
					a = notification['from'].image_url
					a = a.replace(window.location.origin,'')
					this_user_id = a.split('/')[3]
					redirect('messages', user_id, this_user_id)
					Messenger('On');
				})

				var div1 = document.createElement("div")
				div1.classList.add("d-flex", "flex-row", "align-items-start")
				div1.id = assignChatDiv1Id(notification)

				img = createChatProfileImageThumbnail(notification)
				img.id = assignChatImgId(notification)
				div1.appendChild(img)

				var div2 = document.createElement("div")
				div2.classList.add("d-flex", "flex-column")
				div2.id = assignChatDiv2Id(notification)
				
				var title = document.createElement("span")
				title.classList.add("align-items-start")
				title.innerHTML = notification['from']['title']
				title.id = assignChatTitleId(notification)
				div2.appendChild(title)

				var chatRoomMessage = document.createElement("span")
				chatRoomMessage.id = assignChatroomMessageId(notification)
				chatRoomMessage.classList.add("align-items-start", "pt-1", "small", "notification-chatroom-msg")
				if(notification['verb'].length > 50){
					chatRoomMessage.innerHTML = notification['verb'].slice(0, 50) + "..."
				}
				else{
					chatRoomMessage.innerHTML = notification['verb']
				}
				div2.appendChild(chatRoomMessage)
				div1.appendChild(div2)
				card.appendChild(div1)
				card.appendChild(createChatTimestampElement(notification))
				return card
			}

			function appendTopChatNotification(notification){
				switch(notification['notification_type']) {

					case "UnreadChatRoomMessages":
						chatNotificationContainer = document.getElementById("id_chat_notifications_container")
						card = createUnreadChatRoomMessagesElement(notification)

						if(chatNotificationContainer.childNodes.length > 2){
							// Append as the SECOND child. First child is the "go to chatroom" button
							// var index = chatNotificationContainer.childNodes.length - 1
							var index = 2
							chatNotificationContainer.insertBefore(card, chatNotificationContainer.childNodes[index]);
						}
						else {
							chatNotificationContainer.appendChild(card)
						}
						
						break;

					default:
						// code block
				}
			}

			function appendBottomChatNotification(notification){

				switch(notification['notification_type']) {

					case "UnreadChatRoomMessages":
						chatNotificationContainer = document.getElementById("id_chat_notifications_container")
						card = createUnreadChatRoomMessagesElement(notification)
						chatNotificationContainer.appendChild(card)
						break;

					default:
						// code block
				}
			}

			function handleChatNotificationsData(notifications, new_page_number){
				if(notifications.length > 0){
					clearNoChatNotificationsCard()
					
					notifications.forEach(notification => {

						submitChatNotificationToCache(notification)

						setChatNewestTimestamp(notification['timestamp'])
					})
					setChatPageNumber(new_page_number)
				}
			}

			function refreshChatNotificationsList(notification){
				notificationContainer = document.getElementById("id_chat_notifications_container")

				if(notificationContainer != null){
					divs = notificationContainer.childNodes

					divs.forEach(function(card){
						// card
						if(card.id == ("id_notification_" + notification['notification_id'])){
							
							if(notification['notification_type'] == "UnreadChatRoomMessages"){
								refreshUnreadChatRoomMessagesCard(card, notification)
							}
						}
					})
				}
			}

			function refreshUnreadChatRoomMessagesCard(card, notification){

				card.childNodes.forEach(function(element){

					// DIV1
					if(element.id == ("id_chat_div1_" + notification['notification_id'])){
						element.childNodes.forEach(function(child){

							// DIV2
							if(child.id == ("id_chat_div2_" + notification['notification_id'])){
								child.childNodes.forEach(function(nextChild){
									if(nextChild.id == ("id_chat_title_" + notification['notification_id'])){
										// found title
										nextChild.innerHTML = notification['from']['title']
									}
									if(nextChild.id == ("id_chat_message_" + notification['notification_id'])){
										// found chat message
										if(notification['verb'].length > 50){
											nextChild.innerHTML = notification['verb'].slice(0, 50) + "..."
										}
										else{
											nextChild.innerHTML = notification['verb']
										}
									}
								})
							}
						})
					}

					// TIMESTAMP
					if (element.id == ("id_timestamp_" + notification['notification_id'])){
						element.innerHTML = notification['natural_timestamp']
					}
				})
			}

			function setChatPaginationExhausted(){
				setChatPageNumber("-1")
			}

			function setChatPageNumber(pageNumber){
				document.getElementById("id_chat_page_number").innerHTML = pageNumber
			}

			function onChatNotificationsPaginationTriggerListener(){
				window.onscroll = function(ev) {
					// because of rounding we need to add 2. 1 might be OK but I'm using 2.
					if ((window.innerHeight + window.scrollY + 2) >= document.body.scrollHeight) {
						getNextChatNotificationsPage()
					}
				};
			}

			function setOnChatNotificationScrollListener(){
				var menu = document.getElementById("id_chat_notifications_container")
				if(menu != null ){
					menu.addEventListener("scroll", function(e){

						if ((menu.scrollTop) >= (menu.scrollHeight - menu.offsetHeight)) {
							getNextChatNotificationsPage()
						}
					});
				}
				
			}

			function setChatNotificationsCount(count){
				var countElement = document.getElementById("id_chat_notifications_count")
				if(count > 0){
					countElement.style.display = "contents"
					countElement.innerHTML = count
				}
				else{
					countElement.style.background = "transparent"
					countElement.style.display = "none"
				}
			}

			function getUnreadChatNotificationsCount(){
				if("{{request.user.is_authenticated}}"){
					notificationSocket.send(JSON.stringify({
						"command": "get_unread_chat_notifications_count",
					}));
				}
			}

			function getNextChatNotificationsPage(){
				var pageNumber = document.getElementById("id_chat_page_number").innerHTML
				// -1 means exhausted or a query is currently in progress
				if("{{request.user.is_authenticated}}" && pageNumber != "-1"){
					notificationSocket.send(JSON.stringify({
						"command": "get_chat_notifications",
						"page_number": pageNumber,
					}));
				}
			}

			function getNewChatNotifications(){
				newestTimestamp = document.getElementById("id_chat_newest_timestamp").innerHTML
				//console.log("NEWEST TS: " + newestTimestamp)
				if("{{request.user.is_authenticated}}"){
					notificationSocket.send(JSON.stringify({
						"command": "get_new_chat_notifications",
						"newest_timestamp": newestTimestamp,
					}));
				}
			}

			function getFirstChatNotificationsPage(){
				if("{{request.user.is_authenticated}}"){
					notificationSocket.send(JSON.stringify({
						"command": "get_chat_notifications",
						"page_number": "1",
					}));
					getUnreadChatNotificationsCount()
				}
			}

			function startChatNotificationService(){
				if("{{request.user.is_authenticated}}" == "True"){
					setInterval(getNewChatNotifications, CHAT_NOTIFICATION_INTERVAL)
					setInterval(getUnreadChatNotificationsCount, CHAT_NOTIFICATION_INTERVAL)
				}
			}

			startChatNotificationService()

			function assignChatDiv1Id(notification){
				return "id_chat_div1_" + notification['notification_id']
			}

			function assignChatImgId(notification){
				return "id_chat_img_" + notification['notification_id']
			}

			function assignChatTitleId(notification){
				return "id_chat_title_" + notification['notification_id']
			}

			function assignChatroomMessageId(notification){
				return "id_chat_message_" + notification['notification_id']
			}

			function assignChatDiv2Id(notification){
				return "id_chat_div2_" + notification['notification_id']
			}

			function assignChatTimestampId(notification){
				return "id_timestamp_" + notification['notification_id']
			}

			function assignChatCardId(notification){
				return "id_notification_" + notification['notification_id']
			}

			function setChatInitialTimestamp(){
				// ('%Y-%m-%d %H:%M:%S.%f')
				var today = new Date();
				var date = today.getFullYear() + "-01-01 01:00:00.000000"
				document.getElementById("id_chat_newest_timestamp").innerHTML = date
			}

			var chatSocket = null;
			var roomId = null;

			function ChatMessagesAndNotificationsOnStart(){
			    {% if m_and_f %}
			        onSelectFriend("{{m_and_f.0.friend.id}}")
			    {% endif %}
			    {% for x in m_and_f %}
			        preloadImage("{{x.friend.profile_image.url|safe}}", "id_friend_img_{{x.friend.id}}")
			    {% endfor %}
			}

		</script>

		<!-- js/network/network.js -->
		<script>

			console.log('network/network.js')

			function Network(search) {
				search = search.toLowerCase()
				showPage('Network')
				historyPush('Network')
				network = document.getElementsByClassName('profile-container')
				for(let i = 0; i < network.length; i++) {
					r = '';
					profile = network[i].getElementsByClassName('card-title')[0]
					c = profile.innerHTML
					c = c.toLowerCase()
					test = c.includes(search)
					if (test == false) {
						r = 'none';
					}
					c = profile.parentElement.parentElement.parentElement.parentElement
					//
					c.style.display = r
				}
			}   

		</script>

		<!-- js/notification/notification.js -->
		<script>
			
			console.log('notification/notification.js')

			const GENERAL_NOTIFICATION_INTERVAL = 4000
			const GENERAL_NOTIFICATION_TIMEOUT = 5000

			var generalCachedNotifList = new List([])

			function submitGeneralNotificationToCache(notification){
				var result = generalCachedNotifList.filter(function(n){ 
					return n['notification_id'] === notification['notification_id']
				})
				if(result.length == 0){
					generalCachedNotifList.push(notification)

					appendBottomGeneralNotification(notification)
				}
				else{
					refreshGeneralNotificationsList(notification)
				}
			}

			function refreshGeneralNotificationsList(notification){
				notificationContainer = document.getElementById("id_general_notifications_container")

				if(notificationContainer != null){
					divs = notificationContainer.childNodes

					divs.forEach(function(card){
						if(card.id == ("id_notification_" + notification['notification_id'])){
							
							switch(notification['notification_type']) {

								case "FriendRequest":
									refreshFriendRequestCard(card, notification)
									break;

								case "FriendList":
									refreshFriendListCard(card, notification)
									break;

								default:
							}
						}
					})
				}
			}

			function handleGeneralNotificationsData(notifications, new_page_number){
				if(notifications.length > 0){
					clearNoGeneralNotificationsCard()
					notifications.forEach(notification => {

						submitGeneralNotificationToCache(notification)

						setGeneralOldestTimestamp(notification['timestamp'])
						setGeneralNewestTimestamp(notification['timestamp'])
					})
					setGeneralPageNumber(new_page_number)
				}
			}

			function handleNewGeneralNotificationsData(notifications){
				if(notifications.length > 0){
					clearNoGeneralNotificationsCard()
					notifications.forEach(notification => {

						submitNewGeneralNotificationToCache(notification)

						setGeneralOldestTimestamp(notification['timestamp'])
						setGeneralNewestTimestamp(notification['timestamp'])
					})
				}
			}

			function submitNewGeneralNotificationToCache(notification){
				var result = generalCachedNotifList.filter(function(n){ 
					return n['notification_id'] === notification['notification_id']
				})
				if(result.length == 0){
					generalCachedNotifList.push(notification)

					appendTopGeneralNotification(notification)
				}
				else{
					refreshGeneralNotificationsList(notification)
				}
			}

			function refreshGeneralNotificationsData(notifications){
				if(notifications.length > 0){
					clearNoGeneralNotificationsCard()
					notifications.forEach(notification => {

						submitGeneralNotificationToCache(notification)

						setGeneralOldestTimestamp(notification['timestamp'])
						setGeneralNewestTimestamp(notification['timestamp'])
					})
				}
			}

			function appendTopGeneralNotification(notification){

				switch(notification['notification_type']) {

					case "FriendRequest":
						notificationContainer = document.getElementById("id_general_notifications_container")
						card = createFriendRequestElement(notification)
						notificationContainer.insertBefore(card, notificationContainer.childNodes[0]);
						break;

					case "FriendList":
						notificationContainer = document.getElementById("id_general_notifications_container")
						card = createFriendListElement(notification)
						notificationContainer.insertBefore(card, notificationContainer.childNodes[0]);
						break;

					default:
						// code block
				}

				preloadImage(notification['from']['image_url'], assignGeneralImgId(notification))
			}

			function appendBottomGeneralNotification(notification){

				switch(notification['notification_type']) {

					case "FriendRequest":
						notificationContainer = document.getElementById("id_general_notifications_container")
						card = createFriendRequestElement(notification)
						notificationContainer.appendChild(card)
						break;

					case "FriendList":
						notificationContainer = document.getElementById("id_general_notifications_container")
						card = createFriendListElement(notification)
						notificationContainer.appendChild(card)
						break;

					default:
						// code block
				}
				preloadImage(notification['from']['image_url'], assignGeneralImgId(notification))
			}

			function refreshFriendRequestCard(card, notification){
				card.childNodes.forEach(function(element){

					// DIV1
					if(element.id == ("id_general_div1_" + notification['notification_id'])){
						element.childNodes.forEach(function(child){
							if(child.id == ("id_general_verb_" + notification['notification_id'])){
								// found verb
								child.innerHTML = notification['verb']
							}
						})
					}
						
					// DIV2
					if (element.id == ("id_general_div2_" + notification['notification_id'])){
						if(notification['is_active'] == "True"){
								// do nothing
						}
						else{
							// remove buttons b/c it has been answered
							card.removeChild(element)
						}
					}

					// TIMESTAMP
					if (element.id == ("id_timestamp_" + notification['notification_id'])){
						element.innerHTML = notification['natural_timestamp']
					}
				})
			}

			function refreshFriendListCard(card, notification){
				card.childNodes.forEach(function(element){

					// DIV1
					if(element.id == ("id_general_div1_" + notification['notification_id'])){
						element.childNodes.forEach(function(child){
							if(child.id == ("id_general_verb_" + notification['notification_id'])){
								// found verb
								child.innerHTML = notification['verb']
							}
						})
					}

					// TIMESTAMP
					if (element.id == ("id_timestamp_" + notification['notification_id'])){
						element.innerHTML = notification['natural_timestamp']
					}
				})
			}

			function createFriendListElement(notification){
				card = createGeneralNotificationCard()
				card.id = assignGeneralCardId(notification)
				card.addEventListener("click", function(){
					generalRedirect(notification['actions']['redirect_url'])
				})

				var div1 = document.createElement("div")
				div1.classList.add("d-flex", "flex-row", "align-items-start")
				div1.id = assignGeneralDiv1Id(notification)

				img = createGeneralProfileImageThumbnail(notification)
				div1.appendChild(img)

				span = document.createElement("span")
				span.classList.add("align-items-start", "pt-1", "m-auto")
				if(notification['verb'].length > 50){
					span.innerHTML = notification['verb'].slice(0, 50) + "..."
				}
				else{
					span.innerHTML = notification['verb']
				}
				span.id = assignGeneralVerbId(notification)
				div1.appendChild(span)
				card.appendChild(div1)
				card.appendChild(createGeneralTimestampElement(notification))

				return card
			}

			function createFriendRequestElement(notification){
				card = createGeneralNotificationCard()

				// assign id b/c we need to find this div if they accept/decline the friend request
				card.id = assignGeneralCardId(notification)
				//
				card.addEventListener("click", function(){
					a = notification['actions'].redirect_url
					a = a.replace(window.location.origin,'')
					a = a.replaceAll('/','')
					a = a.replaceAll('account','')
					a = a.replaceAll('profile','')
					url = '/' + a + '/profile/'
					window.open(url, '_self');
				})

				// Is the friend request PENDING? (not answered yet)
				if(notification['is_active'] == "True"){

					//console.log("found an active friend request")
					div1 = document.createElement("div")
					div1.classList.add("d-flex", "flex-row", "align-items-start")
					div1.id = assignGeneralDiv1Id(notification)
					
					img = createGeneralProfileImageThumbnail(notification)
					div1.appendChild(img)

					span = document.createElement("span")
					span.classList.add("m-auto")
					span.innerHTML = notification['verb']
					span.id = assignGeneralVerbId(notification)
					div1.appendChild(span)
					card.appendChild(div1)

					div2 = document.createElement("div")
					div2.classList.add("d-flex", "flex-row", "mt-2")
					div2.id = assignGeneralDiv2Id(notification)

					pos_action = document.createElement("a")
					pos_action.classList.add("btn", "btn-primary", "mr-2")
					pos_action.href = "#"
					pos_action.innerHTML = "Accept"
					pos_action.addEventListener("click", function(e){
						e.stopPropagation();
						sendAcceptFriendRequestToSocket(notification['notification_id'])
					})
					pos_action.id = assignGeneralPosActionId(notification)
					div2.appendChild(pos_action)

					neg_action = document.createElement("a")
					neg_action.classList.add("btn", "btn-secondary")
					neg_action.href = "#"
					neg_action.innerHTML = "Decline"
					neg_action.addEventListener("click", function(e){
						e.stopPropagation();
						sendDeclineFriendRequestToSocket(notification['notification_id'])
					})
					neg_action.id = assignGeneralNegActionId(notification)
					div2.appendChild(neg_action)
					card.appendChild(div2)
				}
				// The friend request has been answered (Declined or accepted)
				else{
					var div1 = document.createElement("div")
					div1.classList.add("d-flex", "flex-row", "align-items-start")
					div1.id = assignGeneralDiv1Id(notification)

					img = createGeneralProfileImageThumbnail(notification)
					img.id = assignGeneralImgId(notification)
					div1.appendChild(img)

					span = document.createElement("span")
					span.classList.add("m-auto")
					span.innerHTML = notification['verb']
					span.id = assignGeneralVerbId(notification)
					div1.appendChild(span)
					card.appendChild(div1)
				}
				card.appendChild(createGeneralTimestampElement(notification))

				return card
			}

			function setupGeneralNotificationsMenu(){
				var notificationContainer = document.getElementById("id_general_notifications_container")

				if(notificationContainer != null){
					card = createGeneralNotificationCard("id_no_general_notifications")

					var div = document.createElement("div")
					div.classList.add("d-flex", "flex-row", "align-items-start")

					span = document.createElement("span")
					span.classList.add("align-items-start", "pt-1", "m-auto")
					span.innerHTML = "You have no notifications."
					div.appendChild(span)
					card.appendChild(div)
					notificationContainer.appendChild(card)
				}
			}

			function clearNoGeneralNotificationsCard(){
				var element = document.getElementById("id_no_general_notifications")
				if(element != null && element != "undefined"){
					document.getElementById("id_general_notifications_container").removeChild(element)
				}
			}

			function createGeneralNotificationCard(cardId){
				var card = document.createElement("div")
				if(cardId != "undefined"){
					card.id = cardId
				}
				card.classList.add("d-flex", "flex-column", "align-items-start", "general-card", "p-4")
				return card
			}

			function createGeneralProfileImageThumbnail(notification){
				var img = document.createElement("img")
				img.classList.add("notification-thumbnail-image", "img-fluid", "rounded-circle", "mr-2")
				img.src = "/static/clockdb/dummy_image.png/"
				img.id = assignGeneralImgId(notification)
				return img
			}

			function createGeneralTimestampElement(notification){
				var timestamp = document.createElement("p")
				timestamp.classList.add("small", "pt-2", "timestamp-text")
				timestamp.innerHTML = notification['natural_timestamp']
				timestamp.id = assignGeneralTimestampId(notification)
				return timestamp
			}

			function updateGeneralNotificationDiv(notification){
				notificationContainer = document.getElementById("id_general_notifications_container")

				if(notificationContainer != null){
					divs = notificationContainer.childNodes

					divs.forEach(function(element){
						if(element.id == ("id_notification_" + notification['notification_id'])){
							
							// Replace current div with updated one
							updatedDiv = createFriendRequestElement(notification)
							element.replaceWith(updatedDiv)
						}
					})
				}
			}

			function setOnGeneralNotificationScrollListener(){
				var menu = document.getElementById("id_general_notifications_container")
				if(menu != null ){
					menu.addEventListener("scroll", function(e){

						if ((menu.scrollTop) >= (menu.scrollHeight - menu.offsetHeight)) {
							getNextGeneralNotificationsPage()
						}
					});
				}
			}

			setOnGeneralNotificationScrollListener()

			function setGeneralPaginationExhausted(){
				//console.log("general pagination exhausted.")
				setGeneralPageNumber("-1")
			}

			function setGeneralPageNumber(pageNumber){
				document.getElementById("id_general_page_number").innerHTML = pageNumber
			}

			function setGeneralOldestTimestamp(timestamp){
				element = document.getElementById("id_general_oldest_timestamp")
				current = element.innerHTML
				if(Date.parse(timestamp) < Date.parse(current)){
					element.innerHTML = timestamp
				}
			}

			function setGeneralNewestTimestamp(timestamp){
				element = document.getElementById("id_general_newest_timestamp")
				current = element.innerHTML
				if(Date.parse(timestamp) > Date.parse(current)){
					element.innerHTML = timestamp
				}
				else if(current == ""){
					element.innerHTML = timestamp
				}
			}

			function setUnreadGeneralNotificationsCount(count){
				var countElement = document.getElementById("id_general_notifications_count")
				if(count > 0){
					countElement.style.display = "contents"
					countElement.innerHTML = count
				}
				else{
					countElement.style.background = "transparent"
					countElement.style.display = "none"
				}
			}

			function getUnreadGeneralNotificationsCount(){
				if("{{request.user.is_authenticated}}"){
					notificationSocket.send(JSON.stringify({
						"command": "get_unread_general_notifications_count",
					}));
				}
			}

			function setGeneralNotificationsAsRead(){
				if("{{request.user.is_authenticated}}"){
					oldestTimestamp = document.getElementById("id_general_oldest_timestamp").innerHTML
					notificationSocket.send(JSON.stringify({
						"command": "mark_notifications_read",
					}));
					getUnreadGeneralNotificationsCount()
				}
			}

			function getFirstGeneralNotificationsPage(){
				if("{{request.user.is_authenticated}}"){
					notificationSocket.send(JSON.stringify({
						"command": "get_general_notifications",
						"page_number": "1",
					}));
				}
			}

			function sendAcceptFriendRequestToSocket(notification_id){
				notificationSocket.send(JSON.stringify({
					"command": "accept_friend_request",
					"notification_id": notification_id,
				}));
			}

			function sendDeclineFriendRequestToSocket(notification_id){
				notificationSocket.send(JSON.stringify({
					"command": "decline_friend_request",
					"notification_id": notification_id,
				}));
			}

			function getNextGeneralNotificationsPage(){
				var pageNumber = document.getElementById("id_general_page_number").innerHTML
				// -1 means exhausted or a query is currently in progress
				if("{{request.user.is_authenticated}}" && pageNumber != "-1"){
					notificationSocket.send(JSON.stringify({
						"command": "get_general_notifications",
						"page_number": pageNumber,
					}));
				}
			}

			function refreshGeneralNotifications(){
				oldestTimestamp = document.getElementById("id_general_oldest_timestamp").innerHTML
				newestTimestamp = document.getElementById("id_general_newest_timestamp").innerHTML
				if("{{request.user.is_authenticated}}"){
					notificationSocket.send(JSON.stringify({
						"command": "refresh_general_notifications",
						"oldest_timestamp": oldestTimestamp,
						"newest_timestamp": newestTimestamp,
					}));
				}
			}

			function startGeneralNotificationService(){
				if("{{request.user.is_authenticated}}" == "True"){
					setInterval(refreshGeneralNotifications, GENERAL_NOTIFICATION_INTERVAL)
					setInterval(getNewGeneralNotifications, GENERAL_NOTIFICATION_INTERVAL)
					setInterval(getUnreadGeneralNotificationsCount, GENERAL_NOTIFICATION_INTERVAL)
				}
			}

			startGeneralNotificationService()

			function getNewGeneralNotifications(){
				newestTimestamp = document.getElementById("id_general_newest_timestamp").innerHTML
				if("{{request.user.is_authenticated}}"){
					notificationSocket.send(JSON.stringify({
						"command": "get_new_general_notifications",
						"newest_timestamp": newestTimestamp,
					}));
				}
			}

			function generalRedirect(url){
				window.location.href = url
			}

			function assignGeneralDiv1Id(notification){
				return "id_general_div1_" + notification['notification_id']
			}

			function assignGeneralImgId(notification){
				return "id_general_img_" + notification['notification_id']
			}

			function assignGeneralVerbId(notification){
				return "id_general_verb_" + notification['notification_id']
			}

			function assignGeneralDiv2Id(notification){
				return "id_general_div2_" + notification['notification_id']
			}

			function assignGeneralPosActionId(notification){
				return "id_general_pos_action_" + notification['notification_id']
			}

			function assignGeneralNegActionId(notification){
				return "id_general_neg_action_" + notification['notification_id']
			}

			function assignGeneralTimestampId(notification){
				return "id_timestamp_" + notification['notification_id']
			}

			function assignGeneralCardId(notification){
				return "id_notification_" + notification['notification_id']
			}

			function setInitialTimestamp(){
				// ('%Y-%m-%d %H:%M:%S.%f')
				var today = new Date();
				var month = today.getMonth()+1
				if(month.toString().length == 1){
					month = "0" + month
				}
				var day = today.getDate()
				if(day.toString().length == 1){
					day = "0" + day
				}
				var hours = today.getHours()
				if(hours.toString().length == 1){
					hours = "0" + hours
				}
				var minutes = today.getMinutes()
				if(minutes.toString().length == 1){
					minutes = "0" + minutes
				}
				var seconds = today.getSeconds()
				if(seconds.toString().length == 1){
					seconds = "0" + seconds
				}
				var ms = "000000"
				var date = today.getFullYear()+'-'+month+'-'+day + " " + hours + ":" + minutes + ":" + seconds + "." + ms
				document.getElementById("id_general_oldest_timestamp").innerHTML = date
				document.getElementById("id_general_newest_timestamp").innerHTML = date
			}

			setInitialTimestamp()

		</script>

		<!-- js/posts/posts.js -->
		<script>
			
			console.log('posts/posts.js')

			// onScroll

			window.onscroll = () => {
				var loading = document.getElementById('id_loading_spinner')
				if (loading.style.display == 'none') {
					//
					if (document.getElementById('Posts').style.display != 'none') {
						Posts_Offset = document.getElementsByClassName('post')[0].getElementsByClassName('φ')[0].offsetHeight * (parseInt(localStorage.counter) + 6);
						if (window.scrollY >= Posts_Offset) {
							counter = parseInt(localStorage.counter) + 10
							localStorage.setItem('counter', counter)
							localStorage.setItem('quantity', 10)
							load(url);
						}
					}
					if (document.getElementById('Entities').style.display != 'none') {
						Entities_Offset = parseInt(document.getElementsByClassName('Entity-main')[0].offsetHeight) * (parseInt(localStorage.entities_counter) + 6);
						if (window.scrollY >= Entities_Offset) {
							entities_counter = parseInt(localStorage.entities_counter) + 10
							localStorage.setItem('entities_counter', entities_counter)
							localStorage.setItem('entities_quantity', 10)
							entities_load(url, 'skip');
						}
					}
				}
			};

			// Posts

			function Posts() {
				url = '/entities/'
				PostsUrl(url)
				localStorage.setItem('counter', 1);
				localStorage.setItem('quantity', 10);
				load(url)
			}

			function ClearPosts() {
				document.getElementById('main_posts').innerHTML = '';
			}

			function PostsUrl() {
				p = 0
				url = '/posts/'
				cc = '/'
				a = document.getElementById('Industry')
				a = a.options[a.selectedIndex];
				url = url + a.value + '/'
				if (a.value != 'any') {
					cc = a.innerHTML + '/'
				}
				g = document.getElementsByName('Industry_SEC')
				z = 0
				for(let i = 0; i < g.length; i++) {
					if (g[i].style.display == 'block') {
						a = g[i].getElementsByClassName('select')[0]
						a = a.options[a.selectedIndex];
						url = url + a.value + '/'
						if (a.value != 'any') {
							cc = cc + a.innerHTML + '/'
						}
						z = 1
					}
				}
				if (z == 0) {
					url = url + 'any' + '/'
				}
				a = document.getElementById('Period')
				a = a.options[a.selectedIndex];
				url = url + a.value + '/'
				if (a.value != 'any') {
					cc = cc + a.innerHTML + '/'
				}
				a = document.getElementById('WorkInProgress')
				a = a.options[a.selectedIndex];
				url = url + a.value + '/'
				if (a.value != 'any') {
					cc = cc + a.innerHTML + '/'
				}
				a = document.getElementById('Region')
				a = a.options[a.selectedIndex];
				url = url + a.value + '/'
				if (a.value != 'any') {
					cc = cc + a.innerHTML + '/'
				}
				a = document.getElementById('Order')
				a = a.options[a.selectedIndex];
				url = url + a.value + '/'
				if (a.value != 'any') {
					cc = cc + a.innerHTML + '/'
				}
				a = document.getElementById('Sort')
				a = a.options[a.selectedIndex];
				url = url + a.value + '/'
				if (a.value != 'any') {
					cc = cc + a.innerHTML + '/'
				}
				if (cc == '/') {
					cc = ''
				}
				document.getElementsByClassName('posts_search_criterias')[0].innerHTML = cc;
			}

			function load(url) {
				const loading = document.getElementById('id_loading_spinner');
				loading.style.display = 'block';
				counter = parseInt(localStorage.counter)
				quantity = parseInt(localStorage.quantity)
				const start = counter;
				var end = start + quantity - 1;
				url = url + start + '/' + end + '/'
				fetch(url)
					.then(response => response.json())
					.then(data => {
						d = data.len
						if (d > 1) {
							a = d + ' results'
						} else {
							if (d == 0) {
								a = 'No result'
							} else {
								a = d + ' result'
							}
						}
						document.getElementsByClassName('posts_search_len')[0].innerHTML = a
						data.posts.forEach(add_post);
						LineChart();
						Puck();
						loading.style.display = 'none';
					});
			};

			function add_post(contents) {
				var numUSD = new Intl.NumberFormat("en-US", {
					format: "number"
				})
				var Price = new Intl.NumberFormat("en-US", {
					format: "currency",
					minimumFractionDigits: 2,
					maximumFractionDigits: 2
				});
				const post = document.createElement('span');
				post.className = 'post';
				//
				date(contents.lastyear);
				lastyear = d;
				date(contents.secondlastyear);
				secondlastyear = d;
				date(contents.thirdlastyear);
				thirdlastyear = d;
				date(contents.fourthlastyear)
				fourthlastyear = d;
				//
				amendlastyear = contents.amendlastyear
				amendsecondlastyear = contents.amendsecondlastyear
				amendthirdlastyear = contents.amendthirdlastyear
				amendfourthlastyear = contents.amendfourthlastyear
				//
				datetime(contents.SecuritiesUpdate);
				securitiesupdate = 'Shares Price as of ' + d;
				//
				Opinion1 = contents.OpinionφLastYear
				if (Opinion1 == null) {
					Opinion1 = ''
				}
				Opinion2 = contents.OpinionφSecondLastYear
				if (Opinion2 == null) {
					Opinion2 = ''
				}
				Opinion3 = contents.OpinionφThirdLastYear
				if (Opinion3 == null) {
					Opinion3 = ''
				}
				Opinion4 = contents.OpinionφFourthLastYear
				if (Opinion4 == null) {
					Opinion4 = ''
				}
				Clock1 = contents.ClockφLastYear
				if (Clock1 == null) {
					Clock1 = ''
				} else {
					Clock1 = Clock1 + '%'
				}
				Clock2 = contents.ClockφSecondLastYear
				if (Clock2 == null) {
					Clock2 = ''
				} else {
					Clock2 = Clock2 + '%'
				}
				Clock3 = contents.ClockφThirdLastYear
				if (Clock3 == null) {
					Clock3 = ''
				} else {
					Clock3 = Clock3 + '%'
				}
				Clock4 = contents.ClockφFourthLastYear
				if (Clock4 == null) {
					Clock4 = ''
				} else {
					Clock4 = Clock4 + '%'
				}
				//
				Bridge1 = contents.BridgeφLastYear
				Bridge2 = contents.BridgeφSecondLastYear
				Bridge3 = contents.BridgeφThirdLastYear
				Bridge4 = contents.BridgeφFourthLastYear
				//
				IV1 = numUSD.format(contents.CommonSharesIntrinsicValueLastYear);
				IV2 = numUSD.format(contents.CommonSharesIntrinsicValueSecondLastYear);
				IV3 = numUSD.format(contents.CommonSharesIntrinsicValueThirdLastYear);
				IV4 = numUSD.format(contents.CommonSharesIntrinsicValueFourthLastYear);
				//
				MC1 = numUSD.format(contents.MarketCapitalizationLastYear);
				MC2 = numUSD.format(contents.MarketCapitalizationSecondLastYear);
				MC3 = numUSD.format(contents.MarketCapitalizationThirdLastYear);
				MC4 = numUSD.format(contents.MarketCapitalizationFourthLastYear);
				//
				iv1 = Price.format(contents.CommonShareIntrinsicValueLastYear);
				iv2 = Price.format(contents.CommonShareIntrinsicValueSecondLastYear);
				iv3 = Price.format(contents.CommonShareIntrinsicValueThirdLastYear);
				iv4 = Price.format(contents.CommonShareIntrinsicValueFourthLastYear);
				//
				price1 = Price.format(contents.CommonSharePriceLastYear);
				price2 = Price.format(contents.CommonSharePriceSecondLastYear);
				price3 = Price.format(contents.CommonSharePriceThirdLastYear);
				price4 = Price.format(contents.CommonSharePriceFourthLastYear);
				//
				shares1 = numUSD.format(contents.CommonSharesOutstandingLastYear);
				shares2 = numUSD.format(contents.CommonSharesOutstandingSecondLastYear);
				shares3 = numUSD.format(contents.CommonSharesOutstandingThirdLastYear);
				shares4 = numUSD.format(contents.CommonSharesOutstandingFourthLastYear);
				//
				post.id = contents.tradingSymbol;
				post.innerHTML = `
					{% include 'search/Post.html' %}
				`;
				document.querySelector('#main_posts').append(post);
			};

			function LineChartButton() {
				a = event.target.id
				a = a.replace('Button','')
				document.getElementById(a).style.display = 'block';
				a = a.replace('LineChart','')
				b = 'Opinion' + a
				document.getElementById(b).style.display = 'none';
				b = 'Share' + a
				document.getElementById(b).style.display = 'none';
				b = 'Comments' + a
				document.getElementById(b).style.display = 'none';
			}

			function OpinionButton() {
				a = event.target.id
				a = a.replace('Button','')
				document.getElementById(a).style.display = 'block';
				a = a.replace('Opinion','')
				b = 'LineChart' + a
				document.getElementById(b).style.display = 'none';
				b = 'Share' + a
				document.getElementById(b).style.display = 'none';
				b = 'Comments' + a
				document.getElementById(b).style.display = 'none';
			}

			// Entities

			function Entities(search) {
				if (search != '') {
					search = search.toLowerCase()
					document.getElementById('entities_posts').innerHTML = ''
					showPage('Entities')
					historyPush('Entities')
					url = '/entities/' + search
					localStorage.setItem('entities_counter', 1);
					localStorage.setItem('entities_quantity', 10);
					entities_load(url, search)
				}
			}

			function entities_load(url, search) {
				const loading = document.getElementById('id_loading_spinner');
				loading.style.display = 'block';
				entities_counter = parseInt(localStorage.entities_counter)
				entities_quantity = parseInt(localStorage.entities_quantity)
				const start = entities_counter;
				var end = start + entities_quantity - 1;
				url = url + '/' + start + '/' + end
				fetch(url)
					.then(response => response.json())
					.then(data => {
						d = data.len
						if (d > 1) {
							a = d + ' results'
						} else {
							if (d == 0) {
								a = 'No result'
							} else {
								a = d + ' result'
							}
						}
						if (search != 'skip') {
							a = a + " for " + "<b><i>" + search + "</i></b>"
							document.getElementsByClassName('entities_search_len')[0].innerHTML = a
						}
						data.entities.forEach(add_entities_post);
						loading.style.display = 'none';
					});
			};

			function add_entities_post(contents) {
				const entities_post = document.createElement('div');
				try {
					entities_post.innerHTML = `
						{% include 'search/Entity.html' %}
					`;
				} catch {}
				document.querySelector('#entities_posts').append(entities_post);
			};

		</script>

		<!-- workingPaper -->

		<!-- js/workingPaper/analysis/audit.js -->
		<script src="{% static 'js/workingPaper/analysis/audit.js' %}"></script>

		<!-- js/workingPaper/analysis/compile.js -->
		<script src="{% static 'js/workingPaper/analysis/compile.js' %}"></script>

		<!-- js/workingPaper/analysis/context.js -->
		<script src="{% static 'js/workingPaper/analysis/context.js' %}"></script>

		<!-- js/workingPaper/analysis/financials.js -->
		<script src="{% static 'js/workingPaper/analysis/financials.js' %}"></script>

		<!-- js/workingPaper/analysis/valuation.js -->
		<script src="{% static 'js/workingPaper/analysis/valuation.js' %}"></script>

		<!-- js/workingPaper/base/base.js -->
		<script src="{% static 'js/workingPaper/base/base.js' %}"></script>

		<!-- js/workingPaper/base/checkboxes.js -->
		<script src="{% static 'js/workingPaper/base/checkboxes.js' %}"></script>

		<!-- js/workingPaper/base/enter.js -->
		<script src="{% static 'js/workingPaper/base/enter.js' %}"></script>

		<!-- js/workingPaper/base/openEditor.js -->
		<script src="{% static 'js/workingPaper/base/openEditor.js' %}"></script>

		<!-- js/workingPaper/base/ref.js -->
		<script src="{% static 'js/workingPaper/base/ref.js' %}"></script>

		<!-- js/workingPaper/base/shortcuts -->
		<script src="{% static 'js/workingPaper/base/shortcuts.js' %}"></script>

		<!-- js/workingPaper/base/tabulation.js -->
		<script src="{% static 'js/workingPaper/base/tabulation.js' %}"></script>

		<!-- js/workingPaper/base/unhideRows.js -->
		<script src="{% static 'js/workingPaper/base/unhideRows.js' %}"></script>

		<!-- js/workingPaper/files/enter.js -->
		<script src="{% static 'js/workingPaper/files/enter.js' %}"></script>

		<!-- js/workingPaper/files/files.js -->
		<script src="{% static 'js/workingPaper/files/files.js' %}"></script>

		<!-- js/workingPaper/files/open.js -->
		<script src="{% static 'js/workingPaper/files/open.js' %}"></script>

		<!-- js/workingPaper/files/print.js -->
		<script src="{% static 'js/workingPaper/files/print.js' %}"></script>

		<!-- js/workingPaper/files/rollover.js -->
		<script src="{% static 'js/workingPaper/files/rollover.js' %}"></script>

		<!-- js/workingPaper/files/save.js -->
		<script src="{% static 'js/workingPaper/files/save.js' %}"></script>

		<!-- js/workingPaper/graph/linechart.js -->
		<script src="{% static 'js/workingPaper/graph/linechart.js' %}"></script>

		<!-- js/workingPaper/graph/puck.js -->
		<script src="{% static 'js/workingPaper/graph/puck.js' %}"></script>

		<!-- dom -->
		<script src="{% static 'js/dom/dom.js' %}"></script>

	</body>

</html>